<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM - 监控及诊断工具GUI | Young Kbt blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <noscript><meta http-equiv="refresh" content="0; url=https://www.youngkbt.cn/noscript/"><style>.theme-vdoing-content { display:none }</noscript>
    <script src="https://fastly.jsdelivr.net/npm/twikoo@1.4.18/dist/twikoo.all.min.js"></script>
    <script>var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?267c5680c2ffb468ca29c45ffe6801da"; 
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
          </script>
    <meta name="description" content="Young Kbt个人博客, VuePress搭建, 使用了 Vdoing 主题, 学习Java, Web, 框架, 微服务, 工具, 前端等相关知识, 记录生活和技术路程, 同时分享编程技巧。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="Young Kbt个人博客, VuePress搭建, 学习Java、Web、框架、微服务、工具、前端等相关知识, 记录生活和技术路程。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.1b4ae9fe.css" as="style"><link rel="preload" href="/assets/js/app.54d6ba7b.js" as="script"><link rel="preload" href="/assets/js/2.987bc333.js" as="script"><link rel="preload" href="/assets/js/131.81f41c07.js" as="script"><link rel="preload" href="/assets/js/15.0df286a9.js" as="script"><link rel="preload" href="/assets/js/8.2849a6c1.js" as="script"><link rel="preload" href="/assets/js/10.d2509b9c.js" as="script"><link rel="preload" href="/assets/js/16.51e1ec1e.js" as="script"><link rel="preload" href="/assets/js/12.b3f130f5.js" as="script"><link rel="prefetch" href="/assets/js/100.7790dd31.js"><link rel="prefetch" href="/assets/js/101.6069a4c9.js"><link rel="prefetch" href="/assets/js/102.98092168.js"><link rel="prefetch" href="/assets/js/103.9b7ba5c7.js"><link rel="prefetch" href="/assets/js/104.67586ec3.js"><link rel="prefetch" href="/assets/js/105.5ed10bd9.js"><link rel="prefetch" href="/assets/js/106.5e82f701.js"><link rel="prefetch" href="/assets/js/107.09abe023.js"><link rel="prefetch" href="/assets/js/108.a6627411.js"><link rel="prefetch" href="/assets/js/109.fdb06211.js"><link rel="prefetch" href="/assets/js/11.b9198ca3.js"><link rel="prefetch" href="/assets/js/110.f161dfe1.js"><link rel="prefetch" href="/assets/js/111.50576e70.js"><link rel="prefetch" href="/assets/js/112.9156d6a5.js"><link rel="prefetch" href="/assets/js/113.82dc6754.js"><link rel="prefetch" href="/assets/js/114.473d9db6.js"><link rel="prefetch" href="/assets/js/115.2f4ab3e0.js"><link rel="prefetch" href="/assets/js/116.fafee970.js"><link rel="prefetch" href="/assets/js/117.332a8303.js"><link rel="prefetch" href="/assets/js/118.717f470b.js"><link rel="prefetch" href="/assets/js/119.fe748a32.js"><link rel="prefetch" href="/assets/js/120.c9723944.js"><link rel="prefetch" href="/assets/js/121.9bea1378.js"><link rel="prefetch" href="/assets/js/122.18ad244f.js"><link rel="prefetch" href="/assets/js/123.cf68e8d2.js"><link rel="prefetch" href="/assets/js/124.bc469ea5.js"><link rel="prefetch" href="/assets/js/125.ccfa31da.js"><link rel="prefetch" href="/assets/js/126.6c2e6617.js"><link rel="prefetch" href="/assets/js/127.c6de8e02.js"><link rel="prefetch" href="/assets/js/128.453befbd.js"><link rel="prefetch" href="/assets/js/129.3e1b1ac4.js"><link rel="prefetch" href="/assets/js/13.96302368.js"><link rel="prefetch" href="/assets/js/130.42c82f36.js"><link rel="prefetch" href="/assets/js/132.d1282d17.js"><link rel="prefetch" href="/assets/js/133.4bc5b0b4.js"><link rel="prefetch" href="/assets/js/134.c02be97d.js"><link rel="prefetch" href="/assets/js/135.4d761712.js"><link rel="prefetch" href="/assets/js/136.320e85a7.js"><link rel="prefetch" href="/assets/js/137.8d878aef.js"><link rel="prefetch" href="/assets/js/138.eb7d1b27.js"><link rel="prefetch" href="/assets/js/139.1d873005.js"><link rel="prefetch" href="/assets/js/14.dca94608.js"><link rel="prefetch" href="/assets/js/140.0f786836.js"><link rel="prefetch" href="/assets/js/141.a0cff34a.js"><link rel="prefetch" href="/assets/js/142.c326a8cc.js"><link rel="prefetch" href="/assets/js/143.4f7ff3ae.js"><link rel="prefetch" href="/assets/js/144.32ec69a6.js"><link rel="prefetch" href="/assets/js/145.1d7d913f.js"><link rel="prefetch" href="/assets/js/146.2707ffd4.js"><link rel="prefetch" href="/assets/js/147.99a0f39c.js"><link rel="prefetch" href="/assets/js/148.f1798ad5.js"><link rel="prefetch" href="/assets/js/149.322a3c79.js"><link rel="prefetch" href="/assets/js/150.ac84cfb1.js"><link rel="prefetch" href="/assets/js/151.5c8b38f9.js"><link rel="prefetch" href="/assets/js/152.62081035.js"><link rel="prefetch" href="/assets/js/153.973e4495.js"><link rel="prefetch" href="/assets/js/154.03f67868.js"><link rel="prefetch" href="/assets/js/155.61e62017.js"><link rel="prefetch" href="/assets/js/156.59cd0795.js"><link rel="prefetch" href="/assets/js/157.be555671.js"><link rel="prefetch" href="/assets/js/158.1b114b30.js"><link rel="prefetch" href="/assets/js/159.a1d0d052.js"><link rel="prefetch" href="/assets/js/160.b666147c.js"><link rel="prefetch" href="/assets/js/161.f5ee61fb.js"><link rel="prefetch" href="/assets/js/162.8062c527.js"><link rel="prefetch" href="/assets/js/163.fcb5fe32.js"><link rel="prefetch" href="/assets/js/164.6bbbb363.js"><link rel="prefetch" href="/assets/js/165.30b2341e.js"><link rel="prefetch" href="/assets/js/166.47358c46.js"><link rel="prefetch" href="/assets/js/167.b3f775a8.js"><link rel="prefetch" href="/assets/js/168.20c539f5.js"><link rel="prefetch" href="/assets/js/169.69a844a9.js"><link rel="prefetch" href="/assets/js/17.c8edb760.js"><link rel="prefetch" href="/assets/js/170.3bdbb1ac.js"><link rel="prefetch" href="/assets/js/171.c07e33a0.js"><link rel="prefetch" href="/assets/js/172.3a9e6b61.js"><link rel="prefetch" href="/assets/js/173.ea92250a.js"><link rel="prefetch" href="/assets/js/174.e719f6d3.js"><link rel="prefetch" href="/assets/js/175.8f27ee02.js"><link rel="prefetch" href="/assets/js/176.7168a5a6.js"><link rel="prefetch" href="/assets/js/177.ec194b14.js"><link rel="prefetch" href="/assets/js/178.25afe039.js"><link rel="prefetch" href="/assets/js/179.5d766b63.js"><link rel="prefetch" href="/assets/js/18.63dc22a1.js"><link rel="prefetch" href="/assets/js/180.873f5d1c.js"><link rel="prefetch" href="/assets/js/181.cb0780d9.js"><link rel="prefetch" href="/assets/js/182.73203d56.js"><link rel="prefetch" href="/assets/js/183.e1894bda.js"><link rel="prefetch" href="/assets/js/184.5d1c3ed3.js"><link rel="prefetch" href="/assets/js/185.0651204a.js"><link rel="prefetch" href="/assets/js/186.9651e6d1.js"><link rel="prefetch" href="/assets/js/187.b00c9281.js"><link rel="prefetch" href="/assets/js/188.37c5b593.js"><link rel="prefetch" href="/assets/js/189.3d552a83.js"><link rel="prefetch" href="/assets/js/19.d982cb4a.js"><link rel="prefetch" href="/assets/js/190.3dc0f050.js"><link rel="prefetch" href="/assets/js/191.021cc406.js"><link rel="prefetch" href="/assets/js/192.32e0833b.js"><link rel="prefetch" href="/assets/js/193.0515c946.js"><link rel="prefetch" href="/assets/js/194.8b7eeba2.js"><link rel="prefetch" href="/assets/js/195.a3931535.js"><link rel="prefetch" href="/assets/js/196.27c63011.js"><link rel="prefetch" href="/assets/js/197.9bb65fa4.js"><link rel="prefetch" href="/assets/js/198.ddadf100.js"><link rel="prefetch" href="/assets/js/199.475e18ef.js"><link rel="prefetch" href="/assets/js/20.cadb2e5e.js"><link rel="prefetch" href="/assets/js/200.21480449.js"><link rel="prefetch" href="/assets/js/201.48e22863.js"><link rel="prefetch" href="/assets/js/202.9babefcb.js"><link rel="prefetch" href="/assets/js/203.a82ebe12.js"><link rel="prefetch" href="/assets/js/204.5ac4af6a.js"><link rel="prefetch" href="/assets/js/205.a2c985f2.js"><link rel="prefetch" href="/assets/js/206.84f6c7da.js"><link rel="prefetch" href="/assets/js/207.a9282d37.js"><link rel="prefetch" href="/assets/js/208.23e668b5.js"><link rel="prefetch" href="/assets/js/209.4ccb5992.js"><link rel="prefetch" href="/assets/js/21.07dc002d.js"><link rel="prefetch" href="/assets/js/210.42774d77.js"><link rel="prefetch" href="/assets/js/211.2b5b7172.js"><link rel="prefetch" href="/assets/js/212.c401fba6.js"><link rel="prefetch" href="/assets/js/213.2ae13e77.js"><link rel="prefetch" href="/assets/js/214.0532e22e.js"><link rel="prefetch" href="/assets/js/215.a47019da.js"><link rel="prefetch" href="/assets/js/216.d04a4738.js"><link rel="prefetch" href="/assets/js/217.a795f21c.js"><link rel="prefetch" href="/assets/js/218.d6342419.js"><link rel="prefetch" href="/assets/js/219.67247d19.js"><link rel="prefetch" href="/assets/js/22.09a75b09.js"><link rel="prefetch" href="/assets/js/220.d4de8cce.js"><link rel="prefetch" href="/assets/js/221.cf4625cf.js"><link rel="prefetch" href="/assets/js/222.70761539.js"><link rel="prefetch" href="/assets/js/223.9d4d7f7c.js"><link rel="prefetch" href="/assets/js/224.ca45b950.js"><link rel="prefetch" href="/assets/js/225.65569db8.js"><link rel="prefetch" href="/assets/js/226.d20a204f.js"><link rel="prefetch" href="/assets/js/227.d6057ccf.js"><link rel="prefetch" href="/assets/js/228.f8711a8b.js"><link rel="prefetch" href="/assets/js/229.f795ee40.js"><link rel="prefetch" href="/assets/js/23.3af3961b.js"><link rel="prefetch" href="/assets/js/230.c5bf17df.js"><link rel="prefetch" href="/assets/js/231.6ccb01aa.js"><link rel="prefetch" href="/assets/js/232.6bb5af6a.js"><link rel="prefetch" href="/assets/js/233.74b02883.js"><link rel="prefetch" href="/assets/js/234.7ec66f25.js"><link rel="prefetch" href="/assets/js/235.4e679dd0.js"><link rel="prefetch" href="/assets/js/236.fd82bd3f.js"><link rel="prefetch" href="/assets/js/237.877c8ee4.js"><link rel="prefetch" href="/assets/js/238.9d44ddc5.js"><link rel="prefetch" href="/assets/js/239.88dc7f86.js"><link rel="prefetch" href="/assets/js/24.3db06987.js"><link rel="prefetch" href="/assets/js/240.3080bd08.js"><link rel="prefetch" href="/assets/js/241.4278764b.js"><link rel="prefetch" href="/assets/js/242.a19b849d.js"><link rel="prefetch" href="/assets/js/243.ebdf37e8.js"><link rel="prefetch" href="/assets/js/244.a942a89b.js"><link rel="prefetch" href="/assets/js/245.b57e1eec.js"><link rel="prefetch" href="/assets/js/246.28b29f2c.js"><link rel="prefetch" href="/assets/js/247.0ef4e3c1.js"><link rel="prefetch" href="/assets/js/248.cc3ca371.js"><link rel="prefetch" href="/assets/js/249.1efb811a.js"><link rel="prefetch" href="/assets/js/25.dbee7081.js"><link rel="prefetch" href="/assets/js/250.d82da262.js"><link rel="prefetch" href="/assets/js/251.f9d72d0c.js"><link rel="prefetch" href="/assets/js/252.53fdda2e.js"><link rel="prefetch" href="/assets/js/253.d348ea7a.js"><link rel="prefetch" href="/assets/js/254.ac960631.js"><link rel="prefetch" href="/assets/js/255.1d2389e5.js"><link rel="prefetch" href="/assets/js/256.5b6ce50e.js"><link rel="prefetch" href="/assets/js/257.ff095016.js"><link rel="prefetch" href="/assets/js/258.389064d9.js"><link rel="prefetch" href="/assets/js/259.b9d7286e.js"><link rel="prefetch" href="/assets/js/26.adf0b0e4.js"><link rel="prefetch" href="/assets/js/260.f52a5eaa.js"><link rel="prefetch" href="/assets/js/261.879ff563.js"><link rel="prefetch" href="/assets/js/262.efff98d4.js"><link rel="prefetch" href="/assets/js/263.4bafe038.js"><link rel="prefetch" href="/assets/js/264.af31984d.js"><link rel="prefetch" href="/assets/js/265.83d15a65.js"><link rel="prefetch" href="/assets/js/266.47f295e7.js"><link rel="prefetch" href="/assets/js/267.e10e6e86.js"><link rel="prefetch" href="/assets/js/268.aeda9416.js"><link rel="prefetch" href="/assets/js/269.01e00d8d.js"><link rel="prefetch" href="/assets/js/27.a09568b7.js"><link rel="prefetch" href="/assets/js/270.68ecd5f1.js"><link rel="prefetch" href="/assets/js/271.144eb96c.js"><link rel="prefetch" href="/assets/js/272.f1f0e6e1.js"><link rel="prefetch" href="/assets/js/273.0695776f.js"><link rel="prefetch" href="/assets/js/274.b72e9dc8.js"><link rel="prefetch" href="/assets/js/275.820cff25.js"><link rel="prefetch" href="/assets/js/276.c4d662ed.js"><link rel="prefetch" href="/assets/js/277.ca26b9a9.js"><link rel="prefetch" href="/assets/js/278.8fe04339.js"><link rel="prefetch" href="/assets/js/279.3cf0fb79.js"><link rel="prefetch" href="/assets/js/28.8522e871.js"><link rel="prefetch" href="/assets/js/280.0ff1ed10.js"><link rel="prefetch" href="/assets/js/281.0dba041d.js"><link rel="prefetch" href="/assets/js/282.e184e901.js"><link rel="prefetch" href="/assets/js/283.46d1e534.js"><link rel="prefetch" href="/assets/js/284.c4917c43.js"><link rel="prefetch" href="/assets/js/285.ffccb5f9.js"><link rel="prefetch" href="/assets/js/286.bc81fdce.js"><link rel="prefetch" href="/assets/js/287.ea0d8624.js"><link rel="prefetch" href="/assets/js/288.914c8f81.js"><link rel="prefetch" href="/assets/js/289.edc93779.js"><link rel="prefetch" href="/assets/js/29.48504f8f.js"><link rel="prefetch" href="/assets/js/290.d4c1f6c5.js"><link rel="prefetch" href="/assets/js/291.7f43446c.js"><link rel="prefetch" href="/assets/js/292.d90f6753.js"><link rel="prefetch" href="/assets/js/293.88cf30a0.js"><link rel="prefetch" href="/assets/js/294.c4250799.js"><link rel="prefetch" href="/assets/js/295.9ead9645.js"><link rel="prefetch" href="/assets/js/296.51125f03.js"><link rel="prefetch" href="/assets/js/297.aa7c8ff1.js"><link rel="prefetch" href="/assets/js/298.8aa97386.js"><link rel="prefetch" href="/assets/js/299.e351d41a.js"><link rel="prefetch" href="/assets/js/3.b8840315.js"><link rel="prefetch" href="/assets/js/30.ab50951f.js"><link rel="prefetch" href="/assets/js/300.07622915.js"><link rel="prefetch" href="/assets/js/301.7df4de13.js"><link rel="prefetch" href="/assets/js/302.14c807d9.js"><link rel="prefetch" href="/assets/js/303.760c93ec.js"><link rel="prefetch" href="/assets/js/304.1c4be5e0.js"><link rel="prefetch" href="/assets/js/305.6e396510.js"><link rel="prefetch" href="/assets/js/306.b434b51d.js"><link rel="prefetch" href="/assets/js/307.2ece86f9.js"><link rel="prefetch" href="/assets/js/308.1b1d40fe.js"><link rel="prefetch" href="/assets/js/309.a0349454.js"><link rel="prefetch" href="/assets/js/31.5b301d35.js"><link rel="prefetch" href="/assets/js/310.f460a66c.js"><link rel="prefetch" href="/assets/js/311.62ba953e.js"><link rel="prefetch" href="/assets/js/312.542adc5a.js"><link rel="prefetch" href="/assets/js/313.f8d84934.js"><link rel="prefetch" href="/assets/js/314.563e02ce.js"><link rel="prefetch" href="/assets/js/315.35a56124.js"><link rel="prefetch" href="/assets/js/316.fcfc99b9.js"><link rel="prefetch" href="/assets/js/317.ab419a81.js"><link rel="prefetch" href="/assets/js/318.09868032.js"><link rel="prefetch" href="/assets/js/319.cd4a2f71.js"><link rel="prefetch" href="/assets/js/32.14e2b32d.js"><link rel="prefetch" href="/assets/js/320.f96cac88.js"><link rel="prefetch" href="/assets/js/321.db211473.js"><link rel="prefetch" href="/assets/js/322.12e691e6.js"><link rel="prefetch" href="/assets/js/323.549c4612.js"><link rel="prefetch" href="/assets/js/324.b639f06a.js"><link rel="prefetch" href="/assets/js/325.5e71a439.js"><link rel="prefetch" href="/assets/js/326.ad57a53f.js"><link rel="prefetch" href="/assets/js/327.5a3a2d51.js"><link rel="prefetch" href="/assets/js/328.00c78ffa.js"><link rel="prefetch" href="/assets/js/329.156e03ea.js"><link rel="prefetch" href="/assets/js/33.bd519343.js"><link rel="prefetch" href="/assets/js/330.73424725.js"><link rel="prefetch" href="/assets/js/331.11e3f9ce.js"><link rel="prefetch" href="/assets/js/332.3f7b0419.js"><link rel="prefetch" href="/assets/js/333.59386bf4.js"><link rel="prefetch" href="/assets/js/334.31f3eb29.js"><link rel="prefetch" href="/assets/js/335.6d41b768.js"><link rel="prefetch" href="/assets/js/336.c453e943.js"><link rel="prefetch" href="/assets/js/337.31d277ef.js"><link rel="prefetch" href="/assets/js/338.e68a1ec6.js"><link rel="prefetch" href="/assets/js/339.4914f8c3.js"><link rel="prefetch" href="/assets/js/34.78e22d0b.js"><link rel="prefetch" href="/assets/js/340.235d25c1.js"><link rel="prefetch" href="/assets/js/341.bade90f6.js"><link rel="prefetch" href="/assets/js/342.7cac50b9.js"><link rel="prefetch" href="/assets/js/343.284d3e3f.js"><link rel="prefetch" href="/assets/js/344.352d29bf.js"><link rel="prefetch" href="/assets/js/345.c9fd0276.js"><link rel="prefetch" href="/assets/js/346.1a14ef3a.js"><link rel="prefetch" href="/assets/js/347.e52f390d.js"><link rel="prefetch" href="/assets/js/348.827a8296.js"><link rel="prefetch" href="/assets/js/349.4c54e1fc.js"><link rel="prefetch" href="/assets/js/35.a4bef8e9.js"><link rel="prefetch" href="/assets/js/350.6b7c5868.js"><link rel="prefetch" href="/assets/js/351.f8f88567.js"><link rel="prefetch" href="/assets/js/352.f923869f.js"><link rel="prefetch" href="/assets/js/353.a0c0ee42.js"><link rel="prefetch" href="/assets/js/354.1fda9ab5.js"><link rel="prefetch" href="/assets/js/355.3a43f499.js"><link rel="prefetch" href="/assets/js/356.5140ec5f.js"><link rel="prefetch" href="/assets/js/357.00444d3e.js"><link rel="prefetch" href="/assets/js/358.78f5dd00.js"><link rel="prefetch" href="/assets/js/36.3af3d0bb.js"><link rel="prefetch" href="/assets/js/37.94b40e5c.js"><link rel="prefetch" href="/assets/js/38.82cde1a6.js"><link rel="prefetch" href="/assets/js/39.bd194854.js"><link rel="prefetch" href="/assets/js/4.003f2a3c.js"><link rel="prefetch" href="/assets/js/40.838ecd61.js"><link rel="prefetch" href="/assets/js/41.bfb79e8e.js"><link rel="prefetch" href="/assets/js/42.a52d6409.js"><link rel="prefetch" href="/assets/js/43.d1f58b40.js"><link rel="prefetch" href="/assets/js/44.3952a257.js"><link rel="prefetch" href="/assets/js/45.64536f97.js"><link rel="prefetch" href="/assets/js/46.a5f78ce8.js"><link rel="prefetch" href="/assets/js/47.10d1f9fc.js"><link rel="prefetch" href="/assets/js/48.e51e4e79.js"><link rel="prefetch" href="/assets/js/49.ac3117dc.js"><link rel="prefetch" href="/assets/js/5.65df04d1.js"><link rel="prefetch" href="/assets/js/50.ebc563d9.js"><link rel="prefetch" href="/assets/js/51.22e42d13.js"><link rel="prefetch" href="/assets/js/52.df77e2dd.js"><link rel="prefetch" href="/assets/js/53.0f5ed981.js"><link rel="prefetch" href="/assets/js/54.ba4a6f18.js"><link rel="prefetch" href="/assets/js/55.fe9280eb.js"><link rel="prefetch" href="/assets/js/56.da8234e0.js"><link rel="prefetch" href="/assets/js/57.00838775.js"><link rel="prefetch" href="/assets/js/58.85da1b48.js"><link rel="prefetch" href="/assets/js/59.0f89d046.js"><link rel="prefetch" href="/assets/js/6.70c51a3d.js"><link rel="prefetch" href="/assets/js/60.95112e0b.js"><link rel="prefetch" href="/assets/js/61.a86b3712.js"><link rel="prefetch" href="/assets/js/62.95c83899.js"><link rel="prefetch" href="/assets/js/63.704c8ac8.js"><link rel="prefetch" href="/assets/js/64.5f90d722.js"><link rel="prefetch" href="/assets/js/65.f37a3716.js"><link rel="prefetch" href="/assets/js/66.f676288f.js"><link rel="prefetch" href="/assets/js/67.c872bca2.js"><link rel="prefetch" href="/assets/js/68.ccf0178a.js"><link rel="prefetch" href="/assets/js/69.1fbb06cc.js"><link rel="prefetch" href="/assets/js/7.8ea17f4b.js"><link rel="prefetch" href="/assets/js/70.66a7cb5d.js"><link rel="prefetch" href="/assets/js/71.a2160150.js"><link rel="prefetch" href="/assets/js/72.1fc6bfd7.js"><link rel="prefetch" href="/assets/js/73.fb869733.js"><link rel="prefetch" href="/assets/js/74.cf915b5d.js"><link rel="prefetch" href="/assets/js/75.d3d494af.js"><link rel="prefetch" href="/assets/js/76.22c87fc9.js"><link rel="prefetch" href="/assets/js/77.5358d116.js"><link rel="prefetch" href="/assets/js/78.ba2f0658.js"><link rel="prefetch" href="/assets/js/79.a05cdfd2.js"><link rel="prefetch" href="/assets/js/80.994c0106.js"><link rel="prefetch" href="/assets/js/81.78d4c69a.js"><link rel="prefetch" href="/assets/js/82.21b6c123.js"><link rel="prefetch" href="/assets/js/83.3d9732fd.js"><link rel="prefetch" href="/assets/js/84.405d9c73.js"><link rel="prefetch" href="/assets/js/85.8d9255d4.js"><link rel="prefetch" href="/assets/js/86.a14c0da2.js"><link rel="prefetch" href="/assets/js/87.25358e99.js"><link rel="prefetch" href="/assets/js/88.039542e2.js"><link rel="prefetch" href="/assets/js/89.f26ae52c.js"><link rel="prefetch" href="/assets/js/9.01b93349.js"><link rel="prefetch" href="/assets/js/90.7d735a95.js"><link rel="prefetch" href="/assets/js/91.73ad2a1b.js"><link rel="prefetch" href="/assets/js/92.64891120.js"><link rel="prefetch" href="/assets/js/93.73c3f4b8.js"><link rel="prefetch" href="/assets/js/94.080ad5a2.js"><link rel="prefetch" href="/assets/js/95.38e708da.js"><link rel="prefetch" href="/assets/js/96.1e0dda22.js"><link rel="prefetch" href="/assets/js/97.201f51a3.js"><link rel="prefetch" href="/assets/js/98.37fcc02a.js"><link rel="prefetch" href="/assets/js/99.7bb997eb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b4ae9fe.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/index/logo.png" alt="Young Kbt blog" class="logo"> <span class="site-name can-hide">Young Kbt blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title router-link-active">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link router-link-active">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li><li class="dropdown-subitem"><a href="/mongodb/" class="nav-link">MongoDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-mvc/" class="nav-link">Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html/" class="nav-link">Html</a></li><li class="dropdown-subitem"><a href="/css/" class="nav-link">css</a></li><li class="dropdown-subitem"><a href="/javascript/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Kele-Bingtang/Kele-Bingtang.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/user/avatar2.png"> <div class="blogger-info"><h3>Shp Liu</h3> <span>朝圣的使徒，正在走向编程的至高殿堂！</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title router-link-active">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link router-link-active">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li><li class="dropdown-subitem"><a href="/mongodb/" class="nav-link">MongoDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-mvc/" class="nav-link">Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html/" class="nav-link">Html</a></li><li class="dropdown-subitem"><a href="/css/" class="nav-link">css</a></li><li class="dropdown-subitem"><a href="/javascript/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/website/introduce/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Kele-Bingtang/Kele-Bingtang.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础 - SE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java进阶 - SE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java集合 - Collection</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java优化 - JUC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java容器 - Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java底层 - JVM</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/jvm/construct/" class="sidebar-link">JVM - Java体系结构</a></li><li><a href="/java/jvm/classloader/" class="sidebar-link">JVM - 类加载子系统</a></li><li><a href="/java/jvm/runtime-data/" class="sidebar-link">JVM - 运行时数据区概述及线程</a></li><li><a href="/java/jvm/counter/" class="sidebar-link">JVM - 程序计数器</a></li><li><a href="/java/jvm/vm-stack/" class="sidebar-link">JVM - 虚拟机栈</a></li><li><a href="/java/jvm/local-interfacek/" class="sidebar-link">JVM - 本地方法接口</a></li><li><a href="/java/jvm/method-stack/" class="sidebar-link">JVM - 本地方法栈</a></li><li><a href="/java/jvm/heap/" class="sidebar-link">JVM - 堆</a></li><li><a href="/java/jvm/method-area/" class="sidebar-link">JVM - 方法区</a></li><li><a href="/java/jvm/layout-position/" class="sidebar-link">JVM - 对象实例化内存布局与访问定位</a></li><li><a href="/java/jvm/direct-memory/" class="sidebar-link">JVM - 直接内存</a></li><li><a href="/java/jvm/execution-engine/" class="sidebar-link">JVM - 执行引擎</a></li><li><a href="/java/jvm/stringtable/" class="sidebar-link">JVM - StringTable字符串常量池</a></li><li><a href="/java/jvm/garbage-collection-overview/" class="sidebar-link">JVM - 垃圾回收概述</a></li><li><a href="/java/jvm/garbage-collection-algorithms/" class="sidebar-link">JVM - 垃圾回收相关算法</a></li><li><a href="/java/jvm/garbage-collection-concepts/" class="sidebar-link">JVM - 垃圾回收相关概念</a></li><li><a href="/java/jvm/garbage-collection/" class="sidebar-link">JVM - 垃圾回收器</a></li><li><a href="/java/jvm/class-file-structure/" class="sidebar-link">JVM - Class文件结构</a></li><li><a href="/java/jvm/bytecode/" class="sidebar-link">JVM - 字节码指令集与解析</a></li><li><a href="/java/jvm/class-loading-process/" class="sidebar-link">JVM - 类的加载过程详解</a></li><li><a href="/java/jvm/on-class-loader/" class="sidebar-link">JVM - 再谈类的加载器</a></li><li><a href="/java/jvm/tuning-overview/" class="sidebar-link">JVM - 调优概述</a></li><li><a href="/java/jvm/monitoring-diagnostic-command/" class="sidebar-link">JVM - 监控及诊断工具命令行</a></li><li><a href="/java/jvm/monitoring-diagnostic-tools/" aria-current="page" class="active sidebar-link">JVM - 监控及诊断工具GUI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#工具概述" class="sidebar-link">工具概述</a></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#jconsole" class="sidebar-link">JConsole</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#三种连接方式" class="sidebar-link">三种连接方式</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#工具图" class="sidebar-link">工具图</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#visual-vm" class="sidebar-link">Visual VM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#插件安装" class="sidebar-link">插件安装</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#连接方式" class="sidebar-link">连接方式</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#主要功能" class="sidebar-link">主要功能</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#eclipse-mat" class="sidebar-link">Eclipse MAT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#优缺点" class="sidebar-link">优缺点</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#获取dump文件" class="sidebar-link">获取dump文件</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#解析dump文件" class="sidebar-link">解析dump文件</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#浅堆和深堆" class="sidebar-link">浅堆和深堆</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#深堆与浅堆案例分析" class="sidebar-link">深堆与浅堆案例分析</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#支配树" class="sidebar-link">支配树</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#tomcat堆溢出分析案例" class="sidebar-link">Tomcat堆溢出分析案例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#再谈内存问题" class="sidebar-link">再谈内存问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#内存泄漏-memory-leak" class="sidebar-link">内存泄漏（memory leak）</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#内存溢出-out-of-memory" class="sidebar-link">内存溢出（out of memory）</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#内存泄露的8种情况" class="sidebar-link">内存泄露的8种情况</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#内存泄露案例分析" class="sidebar-link">内存泄露案例分析</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#使用oql语言查询对象信息" class="sidebar-link">使用OQL语言查询对象信息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#select子句" class="sidebar-link">SELECT子句</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#from子句" class="sidebar-link">FROM子句</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#where子句" class="sidebar-link">WHERE子句</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#内置对象与方法" class="sidebar-link">内置对象与方法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#jprofiler" class="sidebar-link">JProfiler</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#基本概述" class="sidebar-link">基本概述</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#遥感监测-telemetries" class="sidebar-link">遥感监测 Telemetries</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#内存视图-live-memory" class="sidebar-link">内存视图 Live Memory</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#堆遍历-heap-walker" class="sidebar-link">堆遍历 heap walker</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#cpu-视图-cpu-views" class="sidebar-link">cpu 视图（cpu views）</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#线程视图-threads" class="sidebar-link">线程视图 threads</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#监控和锁-monitors-locks" class="sidebar-link">监控和锁 Monitors＆Locks</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#简单案例" class="sidebar-link">简单案例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#arthas" class="sidebar-link">Arthas</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#安装与使用" class="sidebar-link">安装与使用</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#相关指令" class="sidebar-link">相关指令</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#java-misssion-control" class="sidebar-link">Java Misssion Control</a></li><li class="sidebar-sub-header level2"><a href="/java/jvm/monitoring-diagnostic-tools/#其他工具" class="sidebar-link">其他工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#flame-graphs-火焰图" class="sidebar-link">Flame Graphs（火焰图）</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#tprofiler" class="sidebar-link">Tprofiler</a></li><li class="sidebar-sub-header level3"><a href="/java/jvm/monitoring-diagnostic-tools/#btrace" class="sidebar-link">Btrace</a></li></ul></li></ul></li><li><a href="/java/jvm/runtime-parameters/" class="sidebar-link">JVM - 运行时参数</a></li><li><a href="/java/jvm/analyze-gclogs/" class="sidebar-link">JVM - 分析GC日志</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java版本 - 新特性</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Java" title="分类" data-v-06225672>Java</a></li><li data-v-06225672><a href="/categories/?category=Java%E5%BA%95%E5%B1%82%20-%20JVM" title="分类" data-v-06225672>Java底层 - JVM</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://www.youngkbt.cn" target="_blank" title="作者" class="beLink" data-v-06225672>Young Kbt </a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-01-31</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">JVM - 监控及诊断工具GUI<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="工具概述"><a href="#工具概述" class="header-anchor">#</a> 工具概述</h2> <p>使用上一章命令行工具或组合能帮您获取目标 Java 应用性能相关的基础信息，但它们存在下列局限：</p> <ul><li><p>无法获取方法级别的分析数据，如方法间的调用关系、各方法的调用次数和调用时间等（这对定位应用性能瓶颈至关重要）</p></li> <li><p>要求用户登录到目标 Java 应用所在的宿主机上，使用起来不是很方便</p></li> <li><p>分析数据通过终端输出，结果展示不够直观</p></li></ul> <p>为此，JDK 提供了一些内存泄漏的分析工具，如 jconsole，jvisualvm 等，用于辅助开发人员定位问题，但是这些工具很多时候并不足以满足快速定位的需求。所以这里我们介绍的工具相对多一些、丰富一些。</p> <p><strong>JDK 自带的工具</strong></p> <p>自带的工具在 JDK 的 Bin 目录下。</p> <ul><li>jconsole：JDK 自带的可视化监控工具。查看 Java 应用程序的运行概况、监控堆信息、永久区（或元空间）使用情况、类加载情况等</li> <li>Visual VM：Visual VM 是一个工具，它提供了一个可视界面，用于查看 Java 虚拟机上运行的基于 Java 技术的应用程序的详细信息</li> <li>JMC：Java Mission Control，内置 Java Flight Recorder。能够以极低的性能开销收集 Java 虚拟机的性能数据</li></ul> <p><strong>第三方工具</strong></p> <ul><li><p>MAT：MAT（Memory Analyzer Tool）是基于 Eclipse 的内存分析工具，是一个快速、功能丰富的 Java heap 分析工具，它可以帮助我们查找内存泄漏和减少内存消耗</p></li> <li><p>JProfiler：商业软件，需要付费，功能强大</p></li></ul> <h2 id="jconsole"><a href="#jconsole" class="header-anchor">#</a> JConsole</h2> <blockquote><p>官方地址：<code>https://docs.oracle.com/javase/7/docs/technotes/guides/management/jconsole.html</code></p></blockquote> <p>jconsole：从 Java5 开始，在 JDK 中自带的 java 监控和管理控制台。用于对 JVM 中内存、线程和类等的监控，是一个基于 JMX（java management extensions）的 GUI 性能监控工具。</p> <p>直接在 JDK 的 bin 目录下启动 jconsole.exe 命令即可。</p> <h3 id="三种连接方式"><a href="#三种连接方式" class="header-anchor">#</a> 三种连接方式</h3> <p>Local：使用 JConsole 连接一个正在本地系统运行的JVM,并且执行程序的和运行 JConsole 的需要是同一个用户。JConsole 使用文件系统的授权通过 RMIl 连接器连接到平台的 MBean 服务器上。这种从本地连接的监控能力只有 Sun 的 JDK 具有。</p> <p>Remote：使用下面的 URL 通过 RMI 连接器连接到一个 JMX 代理，<code>servicejmx.rmi:///jndi/rmi://hostName:portNum/jmxrmi</code>。JConsole 为建立连接，需要在环境变量中设置 <code>mx.remote.credentials</code> 来指定用户名和密码，从而进行授权。</p> <p>Advanced：使用一个特殊的 URL 连接 JMX 代理。一般情况使用自己定制的连接器而不是 RMI 提供的连接器来连接 JMX 代理，或者是一个使用 JDK1.4 的实现了 JMX 和 JMX Rmote 的应用。</p> <h3 id="工具图"><a href="#工具图" class="header-anchor">#</a> 工具图</h3> <p>概述、内存、线程、类、VM 概要、MBean。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131223023.png" alt="image-20210505141631635"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131223025.png" alt="image-20210505141726143"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131223029.png" alt="image-20210505141924211"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131223032.png" alt="image-20210505141950000"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131223035.png" alt="image-20210505142050157"></p> <h2 id="visual-vm"><a href="#visual-vm" class="header-anchor">#</a> Visual VM</h2> <blockquote><p>官方地址：<code>https://visualvm.github.io/index.html</code></p></blockquote> <p>Visual VM 是一个功能强大的多合一故障诊断和性能监控的可视化工具。它集成了多个 JDK 命令行工具，使用 Visual VM 可用于显示虚拟机进程及进程的配置和环境信息（jps，jinfo），监视应用程序的 CPU、GC、堆、方法区及线程的信息（jstat、jstack）等，甚至代替 JConsole。在 JDK 6 Update 7 以后，Visual VM 便作为 JDK 的一部分发布（VisualVM 在 JDK／bin 目录下）即：它完全免费。</p> <h3 id="插件安装"><a href="#插件安装" class="header-anchor">#</a> 插件安装</h3> <p>Visual VM 的一大特点是支持插件扩展，并且插件安装非常方便。我们既可以通过离线下载插件文件 <code>*.nbm</code>，然后在 Plugin 对话框的已下载页面下，添加已下载的插件。也可以在可用插件页面下，在线安装插件。（<strong>这里建议安装上 Visual GC</strong>）</p> <blockquote><p>插件地址: <code>https://visualvm.github.io/pluginscenters.html</code></p></blockquote> <p>可以在 Idea 按照 Visual VM：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131224448.png" alt="image-20220131224447624"></p> <p>按照完插件之后，重启 Idea ，然后配置 Visual VM 的启动路径：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201143925.png" alt="image-20220131224552415"></p> <h3 id="连接方式"><a href="#连接方式" class="header-anchor">#</a> 连接方式</h3> <blockquote><p>本地连接</p></blockquote> <p>监控本地 Java 进程的 CPU、类、线程等。</p> <blockquote><p>远程连接</p></blockquote> <ul><li>确定远程服务器的 IP 地址</li> <li>添加 JMX，通过 JXM 技术具体监控远端服务器的哪个 Java 进程）</li> <li>修改 JDK 的 <code>bin/catalina.sh</code> 文件，连接远程的 Tomcat</li> <li>在 <code>../conf</code> 中添加 <code>jmxremote.access</code> 和 <code>jmxremote.password</code> 文件</li> <li>将服务器地址改为公网 IP 地址</li> <li>设置阿里云安全策略和防火墙策略</li> <li>启动 Tomcat，查看 Tomcat 启动日志和端口监听</li> <li>JMX 中输入端口号、用户名、密码登录</li></ul> <h3 id="主要功能"><a href="#主要功能" class="header-anchor">#</a> 主要功能</h3> <ul><li>生成/读取堆内存/线程快照</li> <li>查看 JVM 参数和系统属性</li> <li>查看运行中的虚拟机进程</li> <li>程序资源的实时监控</li> <li>JMX 代理连接、远程环境监控、CPU 分析和内存分析</li></ul> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131225516.png" alt="image-20220131225514738"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131225732.png" alt="image-20220131225731574"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131225701.png" alt="image-20220131225659672"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131232929.png" alt="image-20220131232928306"></p> <h2 id="eclipse-mat"><a href="#eclipse-mat" class="header-anchor">#</a> Eclipse MAT</h2> <blockquote><p>官方地址： <code>https://www.eclipse.org/mat/downloads.php</code></p></blockquote> <p>MAT（Memory Analyzer Tool）工具是一款功能强大的 Java 堆内存分析器。可以用于查找内存泄漏以及查看内存消耗情况。MAT 是基于 Eclipse 开发的，不仅可以单独使用，还可以作为插件的形式嵌入在 Eclipse 中使用。是一款免费的性能分析工具，使用起来非常方便。</p> <p>MAT 可以分析 heap dump 文件。在进行内存分析时，只要获得了反映当前设备内存映像的 hprof 文件，通过 MAT 打开就可以直观地看到当前的内存信息。一般说来，这些内存信息包含：</p> <ul><li>所有的对象信息，包括对象实例、成员变量、存储于栈中的基本类型值和存储于堆中的其他对象的引用值</li> <li>所有的类信息，包括 classloader、类名称、父类、静态变量等</li> <li>GCRoot 到所有的这些对象的引用路径</li> <li>线程信息，包括线程的调用栈及此线程的线程局部变量（TLS）</li></ul> <h3 id="优缺点"><a href="#优缺点" class="header-anchor">#</a> 优缺点</h3> <blockquote><p>缺点</p></blockquote> <p>MAT 不是一个万能工具，它并不能处理所有类型的堆存储文件。但是比较主流的厂家和格式，例如 Sun，HP，SAP 所采用的 HPROF 二进制堆存储文件，以及 IBM 的 PHD 堆存储文件等都能被很好的解析。</p> <blockquote><p>优点</p></blockquote> <p>最吸引人的还是能够快速为开发人员生成 <strong>内存泄漏报表</strong>，方便定位问题和分析问题。虽然 MAT 有如此强大的功能，但是内存分析也没有简单到一键完成的程度，很多内存问题还是需要我们从 MAT 展现给我们的信息当中通过经验和直觉来判断才能发现。</p> <h3 id="获取dump文件"><a href="#获取dump文件" class="header-anchor">#</a> 获取dump文件</h3> <p>方法一：通过前一章介绍的 jmap工具生成，可以生成任意一个java进程的dump文件。</p> <p>方法二：通过配置 JVM 参数生成。</p> <ul><li>选项 <code>-XX:+HeapDumpOnOutOfMemoryError</code> 或 <code>-XX:+HeapDumpBeforeFullGC</code></li> <li>选项 <code>-XX:HeapDumpPath</code> 所代表的含义就是当程序出现 <code>OutofMemory</code> 时，将会在相应的目录下生成一份 dump 文件。如果不指定选项 <code>XX:HeapDumpPath</code> 则在当前目录下生成 dump 文件</li></ul> <p>对比：考虑到生产环境中几乎不可能在线对其进行分析，大都是采用离线分析，因此使用 jmap + MAT 工具是最常见的组合。</p> <p>方法三：使用 Visual VM 可以导出堆 dump 文件。</p> <p>方法四：使用 MAT 既可以打开一个已有的堆快照，也可以通过 MAT 直接从活动 Java 程序中导出堆快照。该功能将借助 jps 列出当前正在运行的 Java 进程，以供选择并获取快照。</p> <h3 id="解析dump文件"><a href="#解析dump文件" class="header-anchor">#</a> 解析dump文件</h3> <p>打开一个 dump 文件。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131232638.png" alt="image-20220131232636697"></p> <p>打开后的界面：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131232738.png" alt="image-20220131232737535"></p> <p>概述，查看堆大小，类的数量，类加载器等信息。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131233226.png" alt="image-20220131233225517"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131233534.png" alt="image-20220131233533551"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131233646.png" alt="image-20220131233645314"></p> <blockquote><p>Histogram 直方图</p></blockquote> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131233930.png" alt="image-20220131233915003"></p> <p>thread overview：查看系统中的 Java 线程，查看局部变量表的信息。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131234402.png" alt="image-20220131234401041"></p> <blockquote><p>查看对象互相引用的关系</p></blockquote> <p>在 MAT 工具的 thread overview 中，右键目标类找到 <code>with outgoing references</code> 或 <code>with incoming references</code>。即可查看谁引用了该类，该类引用了谁。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220131234921.png" alt="image-20220131234920860"></p> <h3 id="浅堆和深堆"><a href="#浅堆和深堆" class="header-anchor">#</a> 浅堆和深堆</h3> <p><strong>浅堆（Shallow Heap）</strong></p> <p>指一个对象所消耗的内存。在 32 位系统中，一个对象引用会占据 4 个字节，一个 int 类型会占据 4 个字节，long 型变量会占据 8 个字节，每个对象头需要占用 8 个字节。根据堆快照格式不同，对象的大小可能会向8字节进行对齐。</p> <p>以 String 为例：2 个 int 值共占 8 字节，对象引用占用 4 字节，对象头 8 字节，合计 20 字节，向 8 字节对齐，故占 24 字节。（JDK7 中)</p> <table><thead><tr><th>数据类型</th> <th>类型</th> <th>目的</th></tr></thead> <tbody><tr><td>int</td> <td>hash32</td> <td>0</td></tr> <tr><td>int</td> <td>hash</td> <td>0</td></tr> <tr><td>ref</td> <td>value</td> <td>C:\User\Administration</td></tr></tbody></table> <p>这 24 字节为 String 对象的浅堆大小。它与 String 的 value 实际取值无关，无论字符串长度如何，浅堆大小始终是 24 字节。</p> <p><strong>保留集（Retained Set）</strong></p> <p>对象A的保留集指当对象A被垃圾回收后，可以被释放的所有的对象集合（包括对象 A 本身），即对象A的保留集可以被认为是 <strong>只能通过</strong> 对象 A 被直接或间接访问到的所有对象的集合。通俗地说，就是指仅被对象 A 所持有的对象的集合。</p> <p><strong>深堆（Retained Heap）</strong></p> <p>深堆是指对象的保留集中所有的对象的浅堆大小之和。</p> <p>注意：浅堆指对象本身占用的内存，不包括其内部引用对象的大小。一个对象的深堆指只能通过该对象访问到的（直接或间接）所有对象的浅堆之和，即对象被回收后，可以释放的真实空间。</p> <blockquote><p>对象实际大小</p></blockquote> <p>另外一个常用的概念是对象的实际大小。这里，对象的实际大小定义为一个对象 <strong>所能触及</strong> 的所有对象的浅堆大小之和，也就是通常意义上我们说的对象大小。与深堆相比，似乎这个在日常开发中更为直观利被人接受，<strong>但实际上，这个概念和垃圾回收无关</strong>。</p> <p>下图显示了一个简单的对象引用关系图，对象 A 引用了 C 和 D，对象 B 引用了 C 和 E。那么对象A的浅堆大小只是 A 本身，不含 C 和 D，而 A 的实际大小为 A、C、D 三者之和。而 A 的深堆大小为 A 与 D 之和，由于对象 C 还可以通过对象 B 访问到，因此不在对象 A 的深堆范围内。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201003434.png" alt="image-20220201003432711"></p> <p>练习：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201135833.png" alt="image-20220201003650210"></p> <p>上图中，GC Roots 直接引用了 A 和 B 两个对象。</p> <p>A 对象的 Retained Size = A 对象的 Shallow Size。</p> <p>B 对象的 Retained Size=B 对象的 Shallow Size + C 对象的 Shallow Size。</p> <p>这里不包括 D 对象，因为 D 对象被 GC Roots 直接引用。</p> <p>如果 GC Roots 不引用 D 对象呢？则 D 就只属于 B 调用。如下图：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201135835.png" alt="image-20220201003643235"></p> <h3 id="深堆与浅堆案例分析"><a href="#深堆与浅堆案例分析" class="header-anchor">#</a> 深堆与浅堆案例分析</h3> <p>案例视频：<code>https://www.bilibili.com/video/BV1PJ411n7xZ?p=333</code></p> <p>代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 有一个学生浏览网页的记录程序，它将记录 每个学生访问过的网站地址。
 * 它由三个部分组成：Student、WebPage和StudentTrace三个类
 *
 *  -XX:+HeapDumpBeforeFullGC -XX:HeapDumpPath=d:\student.hprof
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentTrace</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebPage</span><span class="token punctuation">&gt;</span></span> webpages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebPage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createWebPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">WebPage</span> wp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wp<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.&quot;</span> <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wp<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            webpages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">createWebPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建了100个网页</span>
        <span class="token comment">//创建3个学生对象</span>
        <span class="token class-name">Student</span> st3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;Tom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Student</span> st5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;Jerry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Student</span> st7 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">&quot;Lily&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> webpages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> st3<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                st3<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>webpages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> st5<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                st5<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>webpages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> st7<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                st7<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>webpages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        webpages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebPage</span><span class="token punctuation">&gt;</span></span> history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebPage</span><span class="token punctuation">&gt;</span></span> <span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> history<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHistory</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebPage</span><span class="token punctuation">&gt;</span></span> history<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> history<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">WebPage</span> wp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            history<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">WebPage</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p>JVM 参数：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">-</span>XX<span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">HeapDumpBeforeFullGC</span> <span class="token operator">-</span>XX<span class="token operator">:</span><span class="token class-name">HeapDumpPath</span><span class="token operator">=</span>d<span class="token operator">:</span>\student<span class="token punctuation">.</span>hprof
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行后，生成 dump 文件，利用 MAT 打开 dump 文件，找到 thread overview，如图得到其中一个学生的访问数据大小 1288：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201005308.png" alt="image-20220201005307683"></p> <p><strong>计算 1288 怎么得到的</strong>。</p> <p>首先有 15 个 WebPage，每个对应 152 个字节：<code>15 * 152 = 2280</code> 字节，这是 elementData 的实际大小。</p> <p>能被 7 整除，且能被 3 整除，以及能被 7 整除，且能被 5 整除的数值有：0、21、42、63、84、35、70 共 7 个数。</p> <p><code>7 * 152 = 1064</code> 字节。</p> <p>那么我们得到 <code>2280 - 1064 - 1288 = 72</code> 字节，这个 72 字节是什么？</p> <p>15 个 elementData 的元素 * 4 字节 = 60 字节。</p> <p>60 + 8 个对象头的字节 + 数组本身 4 个字节 = 72 字节。</p> <h3 id="支配树"><a href="#支配树" class="header-anchor">#</a> 支配树</h3> <p>支配树的概念源自图论。</p> <p>MAT 提供了一个称为支配树（Dominator Tree）的对象图。支配树体现了对象实例间的支配关系。在对象引用图中，所有指向对象 B 的路径都经过对象 A，则认为 <strong>对象 A 支配对象 B</strong>。如果对象 A 是离对象 B 最近的一个支配对象，则认为对象 A 为对象 B 的 <strong>直接支配者</strong>。支配树是基于对象间的引用图所建立的，它有以下基本性质：</p> <ul><li>对象 A 的子树（所有被对象 A 支配的对象集合）表示对象 A 的 <strong>保留集</strong>(retained set），即深堆</li> <li>如果对象 A 支配对象 B，那么对象 A 的直接支配者也支配对象 B</li> <li>支配树的边与对象引用图的边不直接对应</li></ul> <p>如下图所示：左图表示对象引用图，右图表示左图所对应的支配树。对象 A 和 B 由根对象直接支配，由于在到对象 C 的路径中，可以经过 A，也可以经过 B，因此对象 C 的直接支配者也是根对象。对象 F 与对象 D 相互引用，因为到对象 F 的所有路径必然经过对象 D，因此，对象 D 是对象 F 的直接支配者。而到对象 D 的所有路径中，必然经过对象 C，即使是从对象 F 到对象 D 的引用，从根节点出发，也是经过对象 C 的，所以，对象 D 的直接支配者为对象 C。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201010505.png" alt="image-20220201010504721"></p> <p>同理，对象 E 支配对象 G。到达对象H的可以通过对象 D，也可以通过对象 E，因此对象 D 和 E 都不能支配对象 H，而经过对象 C 既可以到达 D 也可以到达 E，因此对象 C 为对象 H 的直接支配者。</p> <p>在 MAT 中，单击工具栏上的对象支配树按钮，可以打开对象支配树视图。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201010933.png" alt="image-20220201010932876"></p> <p>可以看到，有 8 个 WebPage 属于该学生的，上面案例得到的 7 个 WebPage 属于「共有」，<code>15 - 7 = 8</code> 个 WebPage 属于该学生的「私有」。</p> <h3 id="tomcat堆溢出分析案例"><a href="#tomcat堆溢出分析案例" class="header-anchor">#</a> Tomcat堆溢出分析案例</h3> <blockquote><p>案例视频：<code>https://www.bilibili.com/video/BV1PJ411n7xZ?p=334</code></p></blockquote> <p>Tomcat 是最常用的 Java Servlet 容器之一，同时也可以当做单独的 Web 服务器使用。Tomcat 本身使用 Java 实现，并运行于 Java 虚拟机之上。在大规模请求时，Tomcat 有可能会因为无法承受压力而发生内存溢出错误。这里根据一个被压垮的 Tomcat 的堆快照文件，来分析 Tomcat 在崩溃时的内部情况。</p> <p>图 1：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201012017.png" alt="image-20220201012013800"></p> <p>图 2：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201012136.png" alt="image-20220201012135383"></p> <p>图 3：sessions 对象，它占用了约 17MB 空间。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220208185032.png" alt="image-20220201011857288"></p> <p>图 4：可以看到 sessions 对象为 ConcurrentHashMap，其内部分为 16 个 Segment。从深堆大小看，每个 Segment 都比较平均，大约为 1MB，合计 17MB。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201012355.png" alt="image-20220201012354238"></p> <p>图 5：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201012444.png" alt="image-20220201012443880"></p> <p>图 6：当前堆中含有 9941 个 session，并且每一个 session 的深堆为 1592 字节，合计约 15NB，达到当前堆大小的 50%。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201012627.png" alt="image-20220201012624399"></p> <p>图 7：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201012759.png" alt="image-20220201012758369"></p> <p>图 8：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201012223.png" alt="image-20220201012222622"></p> <p>根据当前的 session 总数，可以计算每秒的平均压力为：<code>9941 / (1403324677648 - 1403324645728) * 1000 = 311</code> 次 / 秒。</p> <p>由此推断，在发生 Tomcat 堆溢出时，Tomcat 在连续 30 秒的时间内，平均每秒接收了约 311 次不同客户端的请求，创建了合计 9941 个 session。</p> <h2 id="再谈内存问题"><a href="#再谈内存问题" class="header-anchor">#</a> 再谈内存问题</h2> <h3 id="内存泄漏-memory-leak"><a href="#内存泄漏-memory-leak" class="header-anchor">#</a> 内存泄漏（memory leak）</h3> <p>可达性分析算法来判断对象是否是不再使用的对象，本质都是判断一个对象是否还被引用。那么对于这种情况下，由于代码的实现不同就会出现很多种内存泄漏问题（让 JVM 误以为此对象还在引用中，无法回收，造成内存泄漏）。</p> <p>是否还被使用？是</p> <p>是否还被需要？否</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201150827.png" alt="image-20210505152542224"></p> <p>严格来说，只有对象不会再被程序用到了，但是 GC 又不能回收他们的情况，才叫内存泄漏。但实际情况很多时候一些不太好的实践（或疏忽）会导致对象的生命周期变得很长甚至导致 00M，也可以叫做宽泛意义上的「内存泄漏」。</p> <p>如下图，当 Y 生命周期结束的时候，X 依然引用着 Y，这时候，垃圾回收期是不会回收对象 Y 的；如果对象 X 还引用着生命周期比较短的 A、B、C，对象 A 又引用着对象 a、b、c，这样就可能造成大量无用的对象不能被回收，进而占据了内存资源，造成内存泄漏，直到内存溢出。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201230257.png" alt="image-20210505152704141"></p> <p>申请了内存用完了不释放，比如一共有 1024M 的内存，分配了 512M 的内存一直不回收，那么可以用的内存只有 512M 了，仿佛泄露掉了一部分；通俗一点讲的话，内存泄漏就是「占着茅坑不拉 shi」</p> <h3 id="内存溢出-out-of-memory"><a href="#内存溢出-out-of-memory" class="header-anchor">#</a> 内存溢出（out of memory）</h3> <p>申请内存时，没有足够的内存可以使用；通俗一点儿讲，一个厕所就三个坑，有两个站着茅坑不走的（内存泄漏），剩下最后一个坑，厕所表示接待压力很大，这时候一下子来了两个人，坑位（内存）就不够了，内存泄漏变成内存溢出了。可见，内存泄漏和内存溢出的关系：内存泄漏的增多，最终会导致内存溢出。</p> <p>泄漏的分类：</p> <ul><li>经常发生：发生内存泄露的代码会被多次执行，每次执行，泄露一块内存</li> <li>偶然发生：在某些特定情况下才会发生</li> <li>一次性：发生内存泄露的方法只会执行一次</li> <li>隐式泄漏：一直占着内存不释放，直到执行结束；严格的说这个不算内存泄漏，因为最终释放掉了，但是如果执行时间特别长，也可能会导致内存耗尽</li></ul> <h3 id="内存泄露的8种情况"><a href="#内存泄露的8种情况" class="header-anchor">#</a> 内存泄露的8种情况</h3> <blockquote><p>静态集合类</p></blockquote> <p>静态集合类，如 HashMap、LinkedList 等等。如果这些容器为静态的，那么它们的生命周期与 JVM 程序一致，则容器中的对象在程序结束之前将不能被释放，从而造成内存泄漏。简单而言，长生命周期的对象持有短生命周期对象的引用，尽管短生命周期的对象不再使用，但是因为长生命周期对象持有它的引用而导致不能被回收。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryLeak</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 静态和类的生命周期一致</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">oomTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 局部变量</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>单例模式</p></blockquote> <p>单例模式，和静态集合导致内存泄露的原因类似，因为单例的静态特性，它的生命周期和 JVM 的生命周期一样长，所以如果单例对象如果持有外部对象的引用，那么这个外部对象也不会被回收，那么就会造成内存泄漏。</p> <blockquote><p>内部类持有外部类</p></blockquote> <p>内部类持有外部类，如果一个外部类的实例对象的方法返回了一个内部类的实例对象。这个内部类对象被长期引用了，即使那个外部类实例对象不再被使用，但由于内部类持有外部类的实例对象，这个外部类对象将不会被垃圾回收，这也会造成内存泄漏。</p> <blockquote><p>各种连接，如数据库连接、网络连接和 IO 连接等</p></blockquote> <p>在对数据库进行操作的过程中，首先需要建立与数据库的连接，当不再使用时，需要调用 close 方法来释放与数据库的连接。只有连接被关闭后，垃圾回收器才会回收对应的对象。否则，如果在访问数据库的过程中，对 Connection、Statement 或 ResultSet 不显性地关闭，将会造成大量的对象无法被回收，从而引起内存泄漏。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Statement</span> stmt <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> stmt<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span>（<span class="token class-name">Exception</span> e）<span class="token punctuation">{</span> <span class="token comment">// 异常日志</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1．关闭结果集 Statement</span>
        <span class="token comment">// 2．关闭声明的对象 ResultSet</span>
        <span class="token comment">// 3．关闭连接 Connection</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>变量不合理的作用域</p></blockquote> <p>变量不合理的作用域。一般而言，一个变量的定义的作用范围大于其使用范围，很有可能会造成内存泄漏。另一方面，如果没有及时地把对象设置为 null，很有可能导致内存泄漏的发生。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsingRandom</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">readFromNet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从网络中接受数据保存到msg中</span>
        <span class="token function">saveDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把msg保存到数据库中</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如上面这个伪代码，通过 readFromNet 方法把接受的消息保存在变量 msg 中，然后调用 saveDB 方法把 msg 的内容保存到数据库中，此时 msg 已经就没用了，由于 msg 的生命周期与对象的生命周期相同，此时 msg 还不能回收，因此造成了内存泄漏。</p> <p>实际上这个 msg 变量可以放在 receiveMsg 方法内部，当方法使用完，那么 msg 的生命周期也就结束，此时就可以回收了。还有一种方法，在使用完 msg 后，把 msg 设置为 null，这样垃圾回收器也会回收 msg 的内存空间。</p> <blockquote><p>改变哈希值</p></blockquote> <p>改变哈希值，当一个对象被存储进 HashSet 集合中以后，就不能修改这个对象中的那些参与计算哈希值的字段了。</p> <p>否则，对象修改后的哈希值与最初存储进 HashSet 集合中时的哈希值就不同了，在这种情况下，即使在 contains 方法使用该对象的当前引用作为的参数去 HashSet 集合中检索对象，也将返回找不到对象的结果，这也会导致无法从 HashSet 集合中单独删除当前对象，造成内存泄漏。</p> <p>这也是 String 为什么被设置成了不可变类型，我们可以放心地把 String 存入 HashSet，或者把 String 当做 HashMap 的 key 值。</p> <p>当我们想把自己定义的类保存到散列表的时候，需要保证对象的 hashCode 不可变。</p> <p>代码示例 1：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 例 1
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChangeHashCode</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashSet</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&quot;AA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">&quot;BB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        p1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;CC&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 导致了内存的泄漏</span>
        set<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除失败</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>

        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&quot;CC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>

        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&quot;AA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!=</span> person<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">:</span> person<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> id<span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token number">31</span> <span class="token operator">*</span> result <span class="token operator">+</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> name<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Person{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;id=&quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span>
                <span class="token string">&quot;, name='&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>输出结果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1002</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'BB'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'CC'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1002</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'BB'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'CC'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'CC'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1002</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'BB'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'CC'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'CC'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token number">1001</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">'AA'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>代码示例 2：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 例 2
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChangeHashCode1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> hs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Point</span> cc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hashCode = 41</span>
        hs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cc<span class="token punctuation">)</span><span class="token punctuation">;</span>

        cc<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hashCode = 51  此行为导致了内存的泄漏</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hs.remove = &quot;</span> <span class="token operator">+</span> hs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
        hs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hs.size = &quot;</span> <span class="token operator">+</span> hs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// size = 2</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setX</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> prime <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> prime <span class="token operator">*</span> result <span class="token operator">+</span> x<span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> obj<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">Point</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> other<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Point{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;x=&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span>
                <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>输出结果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>hs<span class="token punctuation">.</span>remove <span class="token operator">=</span> <span class="token boolean">false</span>
hs<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">[</span><span class="token class-name">Point</span><span class="token punctuation">{</span>x<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Point</span><span class="token punctuation">{</span>x<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>缓存泄露</p></blockquote> <p>内存泄漏的另一个常见来源是缓存，一旦你把对象引用放入到缓存中，他就很容易遗忘。比如：之前项目在一次上线的时候，应用启动奇慢直到夯死，就是因为代码中会加载一个表中的数据到缓存（内存）中，测试环境只有几百条数据，但是生产环境有几百万的数据。</p> <p>对于这个问题，可以使用 WeakHashMap 代表缓存，此种 Map 的特点是，当除了自身有对 key 的引用外，此 key 没有其他引用那么此 map 会自动丢弃此值。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">Map</span> wMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">testWeakHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">testHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> ref1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;obejct1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> ref2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;obejct2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> ref3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;obejct3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> ref4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;obejct4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ref1<span class="token punctuation">,</span> <span class="token string">&quot;cacheObject1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ref2<span class="token punctuation">,</span> <span class="token string">&quot;cacheObject2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ref3<span class="token punctuation">,</span> <span class="token string">&quot;cacheObject3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ref4<span class="token punctuation">,</span> <span class="token string">&quot;cacheObject4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;String引用ref1，ref2，ref3，ref4 消失&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testWeakHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;WeakHashMap GC之前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> o <span class="token operator">:</span> wMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;WeakHashMap GC之后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> o <span class="token operator">:</span> wMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HashMap GC之前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> o <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HashMap GC之后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> o <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>输出结果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span>引用ref1，ref2，ref3，ref4 消失
<span class="token class-name">WeakHashMap</span> GC之前
obejct2<span class="token operator">=</span>cacheObject2
obejct1<span class="token operator">=</span>cacheObject1
<span class="token class-name">WeakHashMap</span> GC之后
<span class="token class-name">HashMap</span> GC之前
obejct4<span class="token operator">=</span>cacheObject4
obejct3<span class="token operator">=</span>cacheObject3
<span class="token class-name">HashMap</span> GC之后
obejct4<span class="token operator">=</span>cacheObject4
obejct3<span class="token operator">=</span>cacheObject3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上面代码和图示主演演示 WeakHashMap 如何自动释放缓存对象，当 init 函数执行完成后，局部变量字符串引用 weakd1，weakd2，d1，d2 都会消失，此时只有静态 map 中保存中对字符串对象的引用，可以看到，调用 gc 之后，HashMap 的没有被回收，而 WeakHashMap 里面的缓存被回收了。</p> <blockquote><p>监听器和其他回调</p></blockquote> <p>内存泄漏第三个常见来源是监听器和其他回调，如果客户端在你实现的 API 中注册回调，却没有显示的取消，那么就会积聚。</p> <p>需要确保回调立即被当作垃圾回收的最佳方法是只保存它的弱引用，例如将他们保存成为 WeakHashMap 中的键。</p> <h3 id="内存泄露案例分析"><a href="#内存泄露案例分析" class="header-anchor">#</a> 内存泄露案例分析</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Stack</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        elements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>DEFAULT_INITIAL_CAPACITY<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Object</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 入栈</span>
        <span class="token function">ensureCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elements<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 错误的做法：存在内存泄漏</span>
   <span class="token comment">// public Object pop() { // 出栈</span>
   <span class="token comment">//     if (size == 0)</span>
   <span class="token comment">//         throw new EmptyStackException();</span>
   <span class="token comment">//     return elements[--size];</span>
   <span class="token comment">// }</span>

   <span class="token comment">// 正确的做法</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EmptyStackException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> elements<span class="token punctuation">[</span><span class="token operator">--</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
        elements<span class="token punctuation">[</span>size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">ensureCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elements<span class="token punctuation">.</span>length <span class="token operator">==</span> size<span class="token punctuation">)</span>
            elements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>上述程序并没有明显的错误，但是这段程序有一个内存泄漏，随着 GC 活动的增加，或者内存占用的不断增加，程序性能的降低就会表现出来，严重时可导致内存泄漏，但是这种失败情况相对较少。</p> <p>代码的主要问题在 pop 函数，下面通过这张图示展现。假设这个栈一直增长，增长后如下图所示</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201160547.png" alt="image-20210505160114618"></p> <p>当进行大量的 pop 操作时，由于引用未进行置空，GC 是不会释放的，如下图所示</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201160457.png" alt="image-20220201160456212"></p> <p>从上图中看以看出，如果栈先增长，再收缩，那么从栈中弹出的对象将不会被当作垃圾回收，即使程序不再使用栈中的这些队象，他们也不会回收，因为栈中仍然保存这对象的引用，俗称过期引用，这个内存泄露很隐蔽。</p> <p>将代码中的 pop()方法变成如下方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EmptyStackException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> elements<span class="token punctuation">[</span><span class="token operator">--</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    elements<span class="token punctuation">[</span>size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>一旦引用过期，清空这些引用，将引用置空。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201160608.png" alt="image-20210505160423289"></p> <h2 id="使用oql语言查询对象信息"><a href="#使用oql语言查询对象信息" class="header-anchor">#</a> 使用OQL语言查询对象信息</h2> <p>MAT 支持一种类似于 SQL 的查询语言 OQL（Object Query Language）。OQL 使用类 SQL 语法，可以在堆中进行对象的查找和筛选。</p> <h3 id="select子句"><a href="#select子句" class="header-anchor">#</a> SELECT子句</h3> <p>在 MAT 中，Select 子句的格式与 SQL 基本一致，用于指定要显示的列。Select 子句中可以使用 <code>＊</code>，查看结果对象的引用实例（相当于 outgoing references）。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Vector v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 <code>OBJECTS</code> 关键字，可以将返回结果集中的项以对象的形式显示。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> objects v<span class="token punctuation">.</span>elementData <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Vector v

<span class="token keyword">SELECT</span> OBJECTS s<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在 Select 子句中，使用 <code>AS RETAINED SET</code> 关键字可以得到所得对象的保留集。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">AS</span> RETAINED <span class="token keyword">SET</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> cn<span class="token punctuation">.</span>kbt<span class="token punctuation">.</span>mat<span class="token punctuation">.</span>Student
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>DISTINCT</code> 关键字用于在结果集中去除重复对象。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> OBJECTS classof<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="from子句"><a href="#from子句" class="header-anchor">#</a> FROM子句</h3> <p>From 子句用于指定查询范围，它可以指定类名、正则表达式或者对象地址。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用正则表达式，限定搜索范围，输出所有 cn.kbt 包下所有类的实例。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">&quot;cn\.kbt\..*&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用类的地址进行搜索。使用类的地址的好处是可以区分被不同 ClassLoader 加载的同一种类型。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token number">0x37a0b4d</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="where子句"><a href="#where子句" class="header-anchor">#</a> WHERE子句</h3> <p>Where 子句用于指定 OQL 的查询条件。OQL 查询将只返回满足 Where 子句指定条件的对象。Where 子句的格式与传统 SQL 极为相似。</p> <p>返回长度大于 10 的 char 数组。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Ichar<span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token keyword">WHERE</span> s<span class="token punctuation">.</span><span class="token variable">@length</span> <span class="token operator">&gt;</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回包含 <code>java</code> 子字符串的所有字符串，使用 <code>LIKE</code> 操作符，<code>LIKE</code> 操作符的操作参数为正则表达式。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String s <span class="token keyword">WHERE</span> toString<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">LIKE</span> <span class="token string">&quot;.*java.*&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回所有 value 域不为 null 的字符串，使用 <code>＝</code> 操作符。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String s <span class="token keyword">where</span> s<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token operator">!=</span> <span class="token boolean">null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>返回数组长度大于 15，并且深堆大于 1000 字节的所有 Vector 对象。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Vector v <span class="token keyword">WHERE</span> v<span class="token punctuation">.</span>elementData<span class="token punctuation">.</span><span class="token variable">@length</span> <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token operator">AND</span> v<span class="token punctuation">.</span><span class="token variable">@retainedHeapSize</span> <span class="token operator">&gt;</span> <span class="token number">1000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="内置对象与方法"><a href="#内置对象与方法" class="header-anchor">#</a> 内置对象与方法</h3> <p>OQL 中可以访问堆内对象的属性，也可以访问堆内代理对象的属性。访问堆内对象的属性时，格式如下，其中 alias 为对象名称：</p> <p>[ &lt;alias&gt;. ] &lt;field&gt; . &lt;field&gt;. &lt;field&gt;</p> <p>访问 <code>java.io.File</code> 对象的 path 属性，并进一步访问 path 的 value 属性：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> toString<span class="token punctuation">(</span>f<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token keyword">File</span> f
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>显示 String 对象的内容、objectid 和 objectAddress。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> s<span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token variable">@objectId</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token variable">@objectAddress</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>显示 <code>java.util.Vector</code> 内部数组的长度。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> v<span class="token punctuation">.</span>elementData<span class="token punctuation">.</span><span class="token variable">@length</span> <span class="token keyword">FROM</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Vector v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>显示所有的 <code>java.util.Vector</code> 对象及其子类型</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> INSTANCEOF java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Vector
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="jprofiler"><a href="#jprofiler" class="header-anchor">#</a> JProfiler</h2> <blockquote><p>官网地址：<code>https://www.ej-technologies.com/products/jprofiler/overview.html</code></p></blockquote> <p>在运行 Java 的时候有时候想测试运行时占用内存情况，这时候就需要使用测试工具查看了。在 eclipse 里面有 Eclipse Memory Analyzer tool（MAT）插件可以测试，而在 IDEA 中也有这么一个插件，就是 JProfiler。JProfiler 是由 ej-technologies 公司开发的一款 Java 应用性能诊断工具。功能强大，但是收费。</p> <h3 id="基本概述"><a href="#基本概述" class="header-anchor">#</a> 基本概述</h3> <p><strong>特点：</strong></p> <ul><li>使用方便、界面操作友好（简单且强大）</li> <li>对被分析的应用影响小（提供模板）</li> <li>CPU，Thread，Memory 分析功能尤其强大</li> <li>支持对 jdbc，noSql，jsp，servlet，socket 等进行分析</li> <li>支持多种模式（离线，在线）的分析</li> <li>支持监控本地、远程的 JVM</li> <li>跨平台，拥有多种操作系统的安装版本</li></ul> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201162722.png" alt="image-20220201162722104"></p> <p><strong>主要功能：</strong></p> <ul><li>方法调用：对方法调用的分析可以帮助您了解应用程序正在做什么，并找到提高其性能的方法</li> <li>内存分配：通过分析堆上对象、引用链和垃圾收集能帮您修复内存泄露问题，优化内存使用</li> <li>线程和锁：JProfiler 提供多种针对线程和锁的分析视图助您发现多线程问题</li> <li>高级子系统：许多性能问题都发生在更高的语义级别上。例如，对于 JDBC 调用，您可能希望找出执行最慢的 SQL 语句。JProfiler 支持对这些子系统进行集成分析</li></ul> <p><strong>Idea 集成安装：</strong></p> <p>视频讲解：<code>https://www.bilibili.com/video/BV1PJ411n7xZ?p=341</code></p> <p><strong>数据采集方式：</strong></p> <p>JProfier 数据采集方式分为两种：Sampling（样本采集）和 Instrumentation（重构模式）。</p> <p><strong>Instrumentation</strong>：这是 JProfiler 全功能模式。在 class 加载之前，JProfier 把相关功能代码写入到需要分析的 class 的 bytecode 中，对正在运行的 jvm 有一定影响。</p> <ul><li>优点：功能强大。在此设置中，调用堆栈信息是准确的</li> <li>缺点：若要分析的 Class 较多，则对应用的性能影响较大，CPU 开销可能很高（取决于 Filter 的控制）。因此使用此模式一般配合 Filter 使用，只对特定的类或包进行分析</li></ul> <p><strong>Sampling</strong>：类似于样本统计，每隔一定时间（5ms）将每个线程栈中方法栈中的信息统计出来。</p> <ul><li>优点：对 CPU 的开销非常低，对应用影响小（即使你不配置任何 Filter）</li> <li>缺点：一些数据／特性不能提供（例如：方法的调用次数、执行时间）</li></ul> <p>注：JProfiler 本身没有指出数据的采集类型，这里的采集类型是针对方法调用的采集类型。因为 JProfiler 的绝大多数核心功能都依赖方法调用采集的数据，所以可以直接认为是 JProfiler 的数据采集类型。</p> <h3 id="遥感监测-telemetries"><a href="#遥感监测-telemetries" class="header-anchor">#</a> 遥感监测 Telemetries</h3> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201163747.png" alt="image-20210505164521410"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201163826.png" alt="image-20220201163821835"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201163851.png" alt="image-20210505164815324"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201163853.png" alt="image-20210505164945192"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201163854.png" alt="image-20210505165010529"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201163856.png" alt="image-20210505165128212"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201163858.png" alt="image-20210505165249919"></p> <h3 id="内存视图-live-memory"><a href="#内存视图-live-memory" class="header-anchor">#</a> 内存视图 Live Memory</h3> <p>Live memory 内存剖析：class／class instance 的相关信息。例如对象的个数，大小，对象创建的方法执行栈，对象创建的热点。</p> <ul><li><strong>所有对象 All Objects</strong>：显示所有加载的类的列表和在堆上分配的实例数。只有 Java 1.5（JVMTI）才会显示此视图。</li></ul> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201164329.png" alt="image-20220201164328735"></p> <ul><li><strong>记录对象 Record Objects</strong>：查看特定时间段对象的分配，并记录分配的调用堆栈。</li> <li><strong>分配访问树 Allocation Call Tree</strong>：显示一棵请求树或者方法、类、包或对已选择类有带注释的分配信息的 J2EE 组件。</li> <li><strong>分配热点 Allocation Hot Spots</strong>：显示一个列表，包括方法、类、包或分配已选类的 J2EE 组件。你可以标注当前值并且显示差异值。对于每个热点都可以显示它的跟踪记录树。</li> <li><strong>类追踪器 Class Tracker</strong>：类跟踪视图可以包含任意数量的图表，显示选定的类和包的实例与时间。</li></ul> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201164332.png" alt="image-20210505164554298"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201164333.png" alt="image-20210505165519790"></p> <h3 id="堆遍历-heap-walker"><a href="#堆遍历-heap-walker" class="header-anchor">#</a> 堆遍历 heap walker</h3> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201164334.png" alt="image-20210505165710620"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201164336.png" alt="image-20210505165823201"></p> <h3 id="cpu-视图-cpu-views"><a href="#cpu-视图-cpu-views" class="header-anchor">#</a> cpu 视图（cpu views）</h3> <p>JProfiler 提供不同的方法来记录访问树以优化性能和细节。线程或者线程组以及线程状况可以被所有的视图选择。所有的视图都可以聚集到方法、类、包或 J2EE 组件等不同层上。</p> <ul><li><strong>访问树 Call Tree</strong>：显示一个积累的自顶向下的树，树中包含所有在 JVM 中已记录的访问队列。JDBC，JMS 和 JNDI 服务请求都被注释在请求树中。请求树可以根据 Servlet 和 JSP 对 URL 的不同需要进行拆分。</li> <li><strong>热点 Hot Spots</strong>：显示消耗时间最多的方法的列表。对每个热点都能够显示回溯树。该热点可以按照方法请求，JDBC，JMS 和 JNDI 服务请求以及按照 URL 请求来进行计算。</li> <li><strong>访问图 Call Graph</strong>：显示一个从已选方法、类、包或 J2EE 组件开始的访问队列的图。</li> <li><strong>方法统计 Method Statistis</strong>：显示一段时间内记录的方法的调用时间细节。</li></ul> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201165054.png" alt="image-20210505170055722"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201165055.png" alt="image-20210505170141278"></p> <h3 id="线程视图-threads"><a href="#线程视图-threads" class="header-anchor">#</a> 线程视图 threads</h3> <p>JProfiler 通过对线程历史的监控判断其运行状态，并监控是否有线程阻塞产生，还能将一个线程所管理的方法以树状形式呈现。对线程剖析。</p> <ul><li><strong>线程历史 Thread History</strong>：显示一个与线程活动和线程状态在一起的活动时间表</li> <li><strong>线程监控 Thread Monitor</strong>：显示一个列表，包括所有的活动线程以及它们目前的活动状况</li> <li><strong>线程转储 Thread Dumps</strong>：显示所有线程的堆栈跟踪</li></ul> <p>线程分析主要关心三个方面：</p> <ul><li>Web 容器的线程最大数。比如：Tomcat 的线程容量应该略大于最大并发数</li> <li>线程阻塞</li> <li>线程死锁</li></ul> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201165339.png" alt="image-20220201165337435"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201165056.png" alt="image-20210505170739972"></p> <h3 id="监控和锁-monitors-locks"><a href="#监控和锁-monitors-locks" class="header-anchor">#</a> 监控和锁 Monitors＆Locks</h3> <p>所有线程持有锁的情况以及锁的信息。观察 JVM 的内部线程并查看状态：</p> <ul><li><strong>死锁探测图表 Current Locking Graph</strong>：显示 JVM 中的当前死锁图表</li> <li><strong>目前使用的监测器 Current Monitors</strong>：显示目前使用的监测器并且包括它们的关联线程</li> <li><strong>锁定历史图表 Locking History Graph</strong>：显示记录在 JVM 中的锁定历史</li> <li><strong>历史检测记录 Monitor History</strong>：显示重大的等待事件和阻塞事件的历史记录</li> <li><strong>监控器使用统计 Monitor Usage Statistics</strong>：显示分组监测，线程和监测类的统计监测数据</li></ul> <h3 id="简单案例"><a href="#简单案例" class="header-anchor">#</a> 简单案例</h3> <blockquote><p>案例 1</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JProfilerTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">ArrayList</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Data</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Data</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//1mb</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> info <span class="token operator">=</span> <span class="token string">&quot;hello,kele&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>利用 Jprofiler 监控代码的执行，查看内存和 GC 的活动。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201170052.png" alt="image-20220201170051789"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201170107.png" alt="image-20220201170106558"></p> <blockquote><p>案例 2</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryLeak</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ArrayList</span> beanList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Bean</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                data<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//10kb</span>
                beanList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Bean</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> info <span class="token operator">=</span> <span class="token string">&quot;hello,kele&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">ArrayList</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 错误的写法：静态与类的声明周期一致，所以上面的变量不会被回收</span>
    <span class="token comment">// ArrayList list = new ArrayList(); // 正确的写法</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>利用 Jprofiler 监控代码的执行，查看内存和 GC 的活动。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201170353.png" alt="image-20220201170352569"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201170507.png" alt="image-20220201170506350"></p> <h2 id="arthas"><a href="#arthas" class="header-anchor">#</a> Arthas</h2> <blockquote><p>官方地址：<code>https://arthas.aliyun.com/doc/quick-start.html</code></p></blockquote> <p>上述工具都必须在服务端项目进程中配置相关的监控参数，然后工具通过远程连接到项目进程，获取相关的数据。这样就会带来一些不便，比如线上环境的网络是隔离的，本地的监控工具根本连不上线上环境。并且类似于 Jprofiler 这样的商业工具，是需要付费的。</p> <p>那么有没有一款工具不需要远程连接，也不需要配置监控参数，同时也提供了丰富的性能监控数据呢？</p> <p>阿里巴巴开源的性能分析神器 Arthas 应运而生。</p> <p>Arthas 是 Alibaba 开源的 Java 诊断工具，深受开发者喜爱。在线排查问题，无需重启；动态跟踪 Java 代码；实时监控 JVM 状态。Arthas 支持 JDK 6 ＋，支持 Linux／Mac／Windows，采用命令行交互模式，同时提供丰富的 Tab 自动补全功能，进一步方便进行问题的定位和诊断。当你遇到以下类似问题而束手无策时，Arthas 可以帮助你解决：</p> <ul><li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception</li> <li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了</li> <li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗</li> <li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现</li> <li>是否有一个全局视角来查看系统的运行状况</li> <li>有什么办法可以监控到 JVM 的实时运行状态</li> <li>怎么快速定位应用的热点，生成火焰图</li></ul> <h3 id="安装与使用"><a href="#安装与使用" class="header-anchor">#</a> 安装与使用</h3> <p>在 Linux 的安装方式：如果速度较慢，可以尝试国内的码云 Gitee 下载。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">wget</span> https://io/arthas/arthas-boot.jar
<span class="token function">wget</span> https://arthas/gitee/io/arthas-boot.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Arthas 只是一个 java 程序，所以可以直接用 <code>java -jar</code> 运行。</p> <p>执行成功后，arthas 提供了一种命令行方式的交互方式，arthas 会检测当前服务器上的 Java 进程，并将进程列表展示出来，用户输入对应的编号（1、2、3、4 ...）进行选择，然后回车。</p> <p>比如：</p> <ul><li>方式一：<code>java -jar arthas-boot.jar</code></li> <li>方式二：运行时选择 Java 进程 PID（先使用 <code>jps</code> 指令），再 <code>java -jar arthas-boot.jar [PID]</code></li></ul> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201172654.png" alt="image-20220201172653188"></p> <p>最后一行 [arthas@5826]$，说明打开进入了监控客户端，在这里就可以执行相关命令进行查看了。</p> <p>除了在命令行查看外，Arthas 目前还支持 Web Console。在成功启动连接进程之后就已经自动启动,可以直接访问 <code>http://127.0.0.1:8563/</code> 访问，页面上的操作模式和控制台完全一样。</p> <p>两个实用指令：</p> <ul><li><p>查看日志：<code>cat -/logs/arthas/arthas.log</code></p></li> <li><p>查看帮助：<code>java -jar arthas-boot.jar -h</code></p></li></ul> <p><strong>工程目录</strong></p> <table><thead><tr><th>目录名</th> <th>作用</th></tr></thead> <tbody><tr><td>arthas-agent</td> <td>基于 JavaAgent 技术的代理</td></tr> <tr><td>bin</td> <td>一些启动脚本</td></tr> <tr><td>arthas-boot</td> <td>Java 版本的一键安装启动脚本</td></tr> <tr><td>arthas-client</td> <td>telnet client 代码</td></tr> <tr><td>arthas-common</td> <td>一些共用的工具类和枚举类</td></tr> <tr><td>arthas-core</td> <td>核心库，各种 arthas 命令的交互和实现</td></tr> <tr><td>arthas-demo</td> <td>示例代码</td></tr> <tr><td>arthas-memorycompiler</td> <td>内存编译器代码</td></tr> <tr><td>arthas-packaging</td> <td>Maven 打包相关</td></tr> <tr><td>arthas-site</td> <td>arthas 站点</td></tr> <tr><td>arthas-spy</td> <td>编织到目标类的各个切面</td></tr> <tr><td>static</td> <td>静态资源</td></tr> <tr><td>arthas-testcase</td> <td>测试</td></tr></tbody></table> <h3 id="相关指令"><a href="#相关指令" class="header-anchor">#</a> 相关指令</h3> <p>指令源于官网，建议看官网，有更详细的介绍和 Demo。</p> <blockquote><p>基础指令</p></blockquote> <table><thead><tr><th>指令</th> <th>作用</th></tr></thead> <tbody><tr><td>quit/exit</td> <td>退出当前 Arthas客户端，其他 Arthas 客户端不受影响</td></tr> <tr><td>stop/shutdown</td> <td>关闭 Arthas 服务端，所有 Arthas 客户端全部退出</td></tr> <tr><td>help</td> <td>查看命令帮助信息</td></tr> <tr><td>cat</td> <td>打印文件内容，和 linux 里的 cat 命令类似</td></tr> <tr><td>echo</td> <td>打印参数，和 linux 里的 echo 命令类似</td></tr> <tr><td>grep</td> <td>匹配查找，和 linux 里的 gep 命令类似</td></tr> <tr><td>tee</td> <td>复制标隹输入到标准输出和指定的文件，和 linux 里的 tee 命令类似</td></tr> <tr><td>pwd</td> <td>复制标隹输入到标准输出和指定的文件，和 linux 里的 tee 命令类似</td></tr> <tr><td>cls</td> <td>清空当前屏幕区域</td></tr> <tr><td>session</td> <td>查看当前会话的信息</td></tr> <tr><td>reset</td> <td>重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端关闭时会重置所有增强过的类</td></tr> <tr><td>version</td> <td>输出当前目标 Java 进程所加载的 Arthas 版本号</td></tr> <tr><td>history</td> <td>打印命令历史</td></tr> <tr><td>keymap</td> <td>Arthas 快捷键列表及自定义快捷键</td></tr></tbody></table> <blockquote><p>jvm 相关</p></blockquote> <table><thead><tr><th>指令</th> <th>选项</th> <th>作用</th></tr></thead> <tbody><tr><td>dashboard</td> <td></td> <td>当前系统的实时数据面板</td></tr> <tr><td></td> <td>-i</td> <td>每间隔多少毫秒输出一次最新的数据面板</td></tr> <tr><td></td> <td>-n</td> <td>一共打印多少次数据面板</td></tr> <tr><td>thread</td> <td></td> <td>查看当前 JVM 的线程堆栈信息</td></tr> <tr><td></td> <td>-b</td> <td>查看出现死锁的线程堆栈信息</td></tr> <tr><td>jvm</td> <td></td> <td>查看当前 JVM 的信息</td></tr> <tr><td>sysprop</td> <td></td> <td>查看和修改 JVM 的系统属性</td></tr> <tr><td>sysem</td> <td></td> <td>查看 JVM 的环境变量</td></tr> <tr><td>vmoption</td> <td></td> <td>查看和修改 JVM 里诊断相关的 option</td></tr> <tr><td>perfcounter</td> <td></td> <td>查看当前 JVM 的 Perf Counter 信息</td></tr> <tr><td>logger</td> <td></td> <td>查看和修改 logger</td></tr> <tr><td>getstatic</td> <td></td> <td>查看类的静态属性</td></tr> <tr><td>ognl</td> <td></td> <td>执行 ognl 表达式</td></tr> <tr><td>mbean</td> <td></td> <td>查看 Mbean 的信息</td></tr> <tr><td>heapdump</td> <td></td> <td>类似 jmap 命令的 heap dump 功能</td></tr> <tr><td></td> <td>--live</td> <td>生成存活的堆 dump 文件</td></tr></tbody></table> <blockquote><p>class/classloader 相关</p></blockquote> <table><thead><tr><th>指令</th> <th>选项</th> <th>作用</th></tr></thead> <tbody><tr><td>sc</td> <td></td> <td>查看 JVM 已加载的类信息</td></tr> <tr><td></td> <td>-d</td> <td>输出当前类的详细信息，包括这个类所加载的原始文件来源、类的声明、加载的 Classloader 等详细信息。如果一个类被多个 Classloader 所加载，则会出现多次</td></tr> <tr><td></td> <td>-E</td> <td>开启正则表达式匹配，默认为通配符匹配</td></tr> <tr><td></td> <td>-f</td> <td>输出当前类的成员变量信息（需要配合参数 <code>-d</code> 一起使用）</td></tr> <tr><td></td> <td>-X</td> <td>指定输出静态变量时属性的遍历深度，默认为 0，即直接使用 toString 输出</td></tr> <tr><td>sm</td> <td></td> <td>查看已加载类的方法信息</td></tr> <tr><td></td> <td>-d</td> <td>展示每个方法的详细信息</td></tr> <tr><td></td> <td>-E</td> <td>开启正则表达式匹配,默认为通配符匹配</td></tr> <tr><td>jad</td> <td></td> <td>反编译指定已加载类的源码</td></tr> <tr><td>mc</td> <td></td> <td>内存编译器，内存编译 .java 文件为 .class 文件</td></tr> <tr><td>retransform</td> <td></td> <td>加载外部的 .class 文件，retransform 到 JVM 里</td></tr> <tr><td>redefine</td> <td></td> <td>加载外部的 .class 文件，redefine 到 JVM 里</td></tr> <tr><td>dump</td> <td></td> <td>dump 已加载类的 byte code 到特定目录</td></tr> <tr><td>classloader</td> <td></td> <td>查看 classloader 的继承树、urts、类加载信息，使用 classloader 去调 getResource</td></tr> <tr><td></td> <td>-t</td> <td>查看 classloader 的继承树</td></tr> <tr><td></td> <td>-l</td> <td>按类加载实例查看统计信息</td></tr> <tr><td></td> <td>-c</td> <td>用 classloader 对应的 hashcode 来查看对应的 Jar urls</td></tr></tbody></table> <p>如：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>sc -d cn.kele.jprofiler <span class="token comment"># 查看 jprofiler 的类信息</span>
sm -d java.lang.String  <span class="token comment"># 查看 String 的方法信息</span>
jad java.lang.String <span class="token comment"># 查看 String 的源码（反编译）</span>
<span class="token function">mc</span> /opt/HelloWorld.java <span class="token comment"># 编译成 HelloWorld.class 文件</span>
retransform /opt/HelloWorld.class  <span class="token comment"># 将 Class 文件放到 JVM 里</span>
classloader <span class="token comment"># 查看 classloader 的继承树、urts、类加载信息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>monitor/watch/trace 相关</p></blockquote> <table><thead><tr><th>指令</th> <th>选项</th> <th>作用</th></tr></thead> <tbody><tr><td>monitor</td> <td></td> <td>方法执行监控，调用次数、执行时间、失败率</td></tr> <tr><td></td> <td>-c</td> <td>统计周期，默认值为 120 秒</td></tr> <tr><td>watch</td> <td></td> <td>方法执行观测，能观察到的范围为：返回值、抛出异常、入参，通过编写 groovy 表达式进行对应变量的查看</td></tr> <tr><td></td> <td>-b</td> <td>在方法调用之前观察（默认关闭）</td></tr> <tr><td></td> <td>-e</td> <td>在方法异常之后观察（默认关闭）</td></tr> <tr><td></td> <td>-s</td> <td>在方法返回之后观察（默认关闭）</td></tr> <tr><td></td> <td>-f</td> <td>在方法结束之后（正常返回和异常返回）观察（默认开启）</td></tr> <tr><td></td> <td>-x</td> <td>指定输岀结果的属性遍历深度，默认为 0</td></tr> <tr><td>trace</td> <td></td> <td>方法内部调用路径，并输出方法路径上的每个节点上耗时</td></tr> <tr><td></td> <td></td> <td>执行次数限制</td></tr> <tr><td>stack</td> <td></td> <td>输出当前方法被调用的调用路径</td></tr> <tr><td>tt</td> <td></td> <td>方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</td></tr></tbody></table> <p>如：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>monitor -c <span class="token number">5</span> cn.kbt.java.Picture <span class="token operator">&lt;</span>init<span class="token operator">&gt;</span>  <span class="token comment"># 监控 init 构造器，每隔 5 秒输出一次信息</span>
<span class="token function">watch</span> cn.kbt.java.Picture <span class="token operator">&lt;</span>init<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>其他</p></blockquote> <table><thead><tr><th>指令</th> <th>作用</th></tr></thead> <tbody><tr><td>jobs</td> <td>列出所有 job</td></tr> <tr><td>kill</td> <td>强制终止任务</td></tr> <tr><td>fg</td> <td>将暂停的任务拉到前台执行</td></tr> <tr><td>bg</td> <td>将暂停的任务放到后台执行</td></tr> <tr><td>grep</td> <td>搜索满足条件的结果</td></tr> <tr><td>plaintext</td> <td>将命令的结果去除 ANSI 颜色</td></tr> <tr><td>wc</td> <td>按行统计输出结果</td></tr> <tr><td>options</td> <td>查看或设置 Arthas 全局开关</td></tr> <tr><td>profiler</td> <td>使用 async -profiler 对应用采样，生成火焰图</td></tr></tbody></table> <h2 id="java-misssion-control"><a href="#java-misssion-control" class="header-anchor">#</a> Java Misssion Control</h2> <blockquote><p>官方地址：<code>https://github.com/JDKMissionControl/jmc</code></p></blockquote> <p>在 Oracle 收购 Sun 之前，Oracle 的 JRockit 虚拟机提供了一款叫做 JRockit Mission Control 的虚拟机诊断工具。</p> <p>在 Oracle 收购 sun 之后，Oracle 公司同时拥有了 Hotspot 和 JRockit 两款虚拟机。根据 Oracle 对于 Java 的战略，在今后的发展中，会将 JRokit 的优秀特性移植到 Hotspot 上。其中一个重要的改进就是在 Sun 的 JDK 中加入了 JRockit 的支持。</p> <p>在 Oracle JDK 7u40 之后，Mission Control 这款工具己经绑定在 Oracle JDK 中发布。</p> <p>自 Java11 开始，本节介绍的 JFR 己经开源。但在之前的 Java 版本，JFR 属于 Commercial Feature 通过 Java 虚拟机参数 <code>-XX:+UnlockCommercialFeatures</code> 开启。</p> <p>Java Mission Control（简称 JMC) ，Java 官方提供的性能强劲的工具，是一个用于对 Java 应用程序进行管理、监视、概要分析和故障排除的工具套件。它包含一个 GUI 客户端以及众多用来收集 Java 虚拟机性能数据的插件如 JMX Console（能够访问用来存放虚拟机齐个于系统运行数据的 MXBeans）以及虚拟机内置的高效 profiling 工具 Java Flight Recorder（JFR）。</p> <p>JMC 的另一个优点就是：采用取样，而不是传统的代码植入技术，对应用性能的影响非常非常小，完全可以开着 JMC 来做压测（唯一影响可能是 Full GC 多了）。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202058.png" alt="image-20210505184358041"></p> <p><strong>Java Flight Recorder</strong></p> <p>Java Flight Recorder 是 JMC 的其中一个组件，能够以极低的性能开销收集 Java 虚拟机的性能数据。与其他工具相比，JFR 的性能开销很小，在默认配置下平均低于 1%。JFR 能够直接访问虚拟机内的敌据并且不会影响虚拟机的优化。因此它非常适用于生产环境下满负荷运行的 Java 程序。</p> <p>Java Flight Recorder 和 JDK Mission Control 共同创建了一个完整的工具链。JDK Mission Control 可对 Java Flight Recorder 连续收集低水平和详细的运行时信息进行高效、详细的分析。</p> <p>当启用时 JFR 将记录运行过程中发生的一系列事件。其中包括 Java 层面的事件如线程事件、锁事件，以及 Java 虚拟机内部的事件，如新建对象，垃圾回收和即时编译事件。按照发生时机以及持续时间来划分，JFR 的事件共有四种类型，它们分别为以下四种：</p> <ul><li><p>瞬时事件（Instant Event) ，用户关心的是它们发生与否，例如异常、线程启动事件。</p></li> <li><p>持续事件(Duration Event) ，用户关心的是它们的持续时间，例如垃圾回收事件。</p></li> <li><p>计时事件(Timed Event) ，是时长超出指定阈值的持续事件。</p></li> <li><p>取样事件（Sample Event)，是周期性取样的事件。</p></li></ul> <p>取样事件的其中一个常见例子便是方法抽样（Method Sampling），即每隔一段时问统计各个线程的栈轨迹。如果在这些抽样取得的栈轨迹中存在一个反复出现的方法，那么我们可以推测该方法是热点方法</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202119.png" alt="image-20210505185941373"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202121.png" alt="image-20210505185954567"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202122.png" alt="image-20210505190009274"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202123.png" alt="image-20210505190023099"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202124.png" alt="image-20210505190037354"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202125.png" alt="image-20210505190052561"></p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202127.png" alt="image-20210505190106004"></p> <h2 id="其他工具"><a href="#其他工具" class="header-anchor">#</a> 其他工具</h2> <h3 id="flame-graphs-火焰图"><a href="#flame-graphs-火焰图" class="header-anchor">#</a> Flame Graphs（火焰图）</h3> <p>在追求极致性能的场景下，了解你的程序运行过程中 CPU 在干什么很重要，火焰图就是一种非常直观的展示 CPU 在程序整个生命周期过程中时间分配的工具。火焰图对于现代的程序员不应该陌生，这个工具可以非常直观的显示出调用找中的 CPU 消耗瓶颈。</p> <p>网上的关于 Java 火焰图的讲解大部分来自于 Brenden Gregg 的博客：<code>http://new.brendangregg.com/flamegraphs.html</code>。</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201202321.png" alt="image-20210505190823214"></p> <p>火焰图，简单通过 x 轴横条宽度来度量时间指标，y 轴代表线程栈的层次。</p> <h3 id="tprofiler"><a href="#tprofiler" class="header-anchor">#</a> Tprofiler</h3> <blockquote><p>官方地址：<code>http://github.com/alibaba/Tprofiler</code></p></blockquote> <p>案例： 使用 JDK 自身提供的工具进行 JVM 调优可以将下 TPS 由 2.5 提升到 20（提升了 7 倍），并准确 定位系统瓶颈。</p> <p>系统瓶颈有：应用里释态对象不是太多、有大量的业务线程在频繁创建一些生命周期很长的临时对象，代码里有问题。</p> <p>那么，如何在海量业务代码里边准确定位这些性能代码？这里使用阿里开源工具 Tprofiler 来定位 这些性能代码，成功解决掉了 GC 过于频繁的性能瓶预，并最终在上次优化的基础上将 TPS 再提升了 4 倍，即提升到 100。</p> <ul><li>Tprofiler 配置部署、远程操作、 日志阅谈都不太复杂，操作还是很简单的。但是其却是能够 起到一针见血、立竿见影的效果，帮我们解决了 GC 过于频繁的性能瓶预。</li> <li>Tprofiler 最重要的特性就是能够统汁出你指定时间段内 JVM 的 top method 这些 top method 极有可能就是造成你 JVM 性能瓶颈的元凶。这是其他大多数 JVM 调优工具所不具备的，包括 JRockit Mission Control。JRokit 首席开发者 Marcus Hirt 在其私人博客《 Lom Overhead Method Profiling cith Java Mission Control》下的评论中曾明确指出 JRMC 井不支持 TOP 方法的统计。</li></ul> <h3 id="btrace"><a href="#btrace" class="header-anchor">#</a> Btrace</h3> <p>常见的动态追踪工具有 BTrace、HouseHD（该项目己经停止开发）、Greys-Anatomy（国人开发 个人开发者）、Byteman（JBoss 出品），注意 Java 运行时追踪工具井不限干这几种，但是这几个是相对比较常用的。</p> <p>BTrace 是 SUN Kenai 云计算开发平台下的一个开源项目，旨在为 java 提供安全可靠的动态跟踪分析工具。先看一卜日 Trace 的官方定义：</p> <p><img src="https://fastly.jsdelivr.net/gh/Kele-Bingtang/static/img/Java/20220201230309.png" alt="image-20210505192042974"></p> <p>大概意思是一个 Java 平台的安全的动态追踪工具，可以用来动态地追踪一个运行的 Java 程序。BTrace 动态调整目标应用程序的类以注入跟踪代码（“字节码跟踪“）。</p> <blockquote><p>其他工具</p></blockquote> <p><strong>YourKit</strong></p> <p><strong>JProbe</strong></p> <p><strong>Spring Insight</strong></p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Kele-Bingtang/Kele-Bingtang.github.io/edit/master/docs/10.Java/20.Java底层 - JVM/47.JVM - 监控及诊断工具GUI.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Java" title="标签">#Java</a></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2022/06/03, 16:16:24</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/java/jvm/monitoring-diagnostic-command/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">JVM - 监控及诊断工具命令行</div></a> <a href="/java/jvm/runtime-parameters/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">JVM - 运行时参数</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/java/jvm/monitoring-diagnostic-command/" class="prev">JVM - 监控及诊断工具命令行</a></span> <span class="next"><a href="/java/jvm/runtime-parameters/">JVM - 运行时参数</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/java/se/reflect/"><div>
            JavaSE - 反射
            <!----></div></a> <span class="date">06-20</span></dt></dl><dl><dd>02</dd> <dt><a href="/algorithm/backtracking/"><div>
            算法思想 - 回溯算法
            <!----></div></a> <span class="date">06-18</span></dt></dl><dl><dd>03</dd> <dt><a href="/algorithm/greedy/"><div>
            算法思想 - 贪心算法
            <!----></div></a> <span class="date">06-01</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/kele-bingtang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/kele-bingtang" title="Gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.youngkbt.cn" title="网站首页" target="_blank" class="iconfont icon-rss"></a><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=28761025&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" class="iconfont icon-QQ"></a><a href="https://www.youngkbt.cn/?contact=true" title="联系我" target="_blank" class="iconfont icon-youjian"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2022
    <span>Young Kbt  | blog<br> <a href="http://beian.miit.gov.cn/" target="_blank">桂ICP备2021009994号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div></div><div></div><div></div><div id="tcomment"></div><!----><APlayer audio="" fixed="true" mini="true" theme="#b7daff" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="0" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer><div></div></div></div>
    <script src="/assets/js/app.54d6ba7b.js" defer></script><script src="/assets/js/2.987bc333.js" defer></script><script src="/assets/js/131.81f41c07.js" defer></script><script src="/assets/js/15.0df286a9.js" defer></script><script src="/assets/js/8.2849a6c1.js" defer></script><script src="/assets/js/10.d2509b9c.js" defer></script><script src="/assets/js/16.51e1ec1e.js" defer></script><script src="/assets/js/12.b3f130f5.js" defer></script>
  </body>
</html>
